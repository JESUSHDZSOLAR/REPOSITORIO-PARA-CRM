<!DOCTYPE html>
<html lang="es">
<head>
<meta http-equiv="Content-Security-Policy" content="
    script-src 'self' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://apis.google.com https://accounts.google.com 'unsafe-inline' 'unsafe-eval';
    style-src 'self' https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline';
    font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com;
    connect-src 'self' http://localhost:3000 https://www.googleapis.com https://apis.google.com https://accounts.google.com https://api.imgbb.com;
    frame-src 'self' https://accounts.google.com https://content.googleapis.com https://drive.google.com https://www.google.com;
    child-src 'self' https://accounts.google.com https://content.googleapis.com https://www.google.com;
    img-src 'self' data: https:;
">
    <title>MI SOLAREVER</title>
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">
    
    <!-- Cargar librerías en el orden CORRECTO -->
   <!-- Cargar librerías en el orden CORRECTO - VERSIÓN CORREGIDA -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        
        .status-pendiente {
            background-color: #fef3c7;
            color: #df841d;
        }
        
        .status-contactado {
            background-color: #e0b2db;
            color: #6812b9;
        }
        
        .status-no-contesto {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .status-vendido {
            background-color: #abf2af;
            color: #089021;
        }
        
        .sidebar {
            transition: all 0.3s;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
        }
        
        /* Overlay para móviles */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 5;
        }
        
        @media (max-width: 768px) {
            .sidebar-overlay.active {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

<div id="main-panel" class="flex h-screen overflow-hidden">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <!-- En el archivo: nuevo - copia.html -->
<!-- Busca esta sección en el sidebar y reemplázala: -->

<div class="sidebar bg-white w-64 shadow-lg fixed md:relative h-full z-10 flex flex-col">
    <div class="flex-1">
        <div class="flex items-center justify-center p-4 border-b">
            <img src="/img/Logo.png" alt="Logo del CRM" class="h-10">
        </div>
        <nav class="mt-4">
            <div class="px-4 py-2 font-medium text-gray-500 uppercase text-xs tracking-wider">Menu</div>
            <a href="#" id="nav-clientes" class="block px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 flex items-center">
                <i class="fas fa-users mr-2"></i> Clientes
            </a>
            <a href="#" id="nav-nuevo-cliente" class="hidden block px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 flex items-center">
                <i class="fas fa-user-plus mr-2"></i> Nuevo Cliente
            </a>
            <a href="#" id="nav-informe" class="block px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 flex items-center">
                <i class="fas fa-chart-bar mr-2"></i> Informes
            </a>
            <!-- En nuevo - copia.html - En el sidebar, después de "Informes" -->
            <a href="#" id="nav-reportes-pdf" class="block px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 flex items-center">
                <i class="fas fa-file-pdf mr-2"></i> Reportes PDF
            </a>
            <!-- En el sidebar, después de "Reportes PDF" -->
<a href="#" id="nav-auditoria" class="block px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 flex items-center">
    <i class="fas fa-history mr-2"></i> Auditoría
</a>
            <div class="px-4 py-2 font-medium text-gray-500 uppercase text-xs tracking-wider mt-4">Configuración</div>
            <a href="#" id="nav-asesores" class="block px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 flex items-center">
                <i class="fas fa-users-cog mr-2"></i> Asesores
            </a>
        </nav>
    </div>
    
    <!-- Botón Cerrar Sesión - Ahora en la esquina inferior derecha -->
    <div class="mt-auto p-4 border-t">
      <button id="btn-cerrar-sesion" class="w-full px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg text-white flex items-center justify-center transition-colors duration-200">
    <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesión
</button>
    </div>
</div>
        
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- En el archivo: nuevo - copia.html -->
<!-- Busca esta sección en el header y reemplázala: -->

<header class="bg-white shadow-sm z-5">
    <div class="flex items-center justify-between px-4 py-3">
        <div class="flex items-center">
            <button id="menu-toggle" class="md:hidden mr-4 text-gray-500 focus:outline-none">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="page-title" class="text-xl font-semibold text-gray-800">MI SOLAREVER</h1>
        </div>
        
        <!-- Contenedor para búsqueda y perfil alineados a la derecha -->
        <div class="flex items-center space-x-4">
            <!-- Buscador de clientes -->
            <div class="relative">
                <input type="text" id="search-clientes" placeholder="Buscar clientes..." 
                    class="pl-10 pr-4 py-2 border rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 w-64">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
            </div>
            
            <!-- Imagen de perfil -->
            <div class="relative">
                <button class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center">
                    <i class="fas fa-user"></i>
                </button>
            </div>
        </div>
    </div>
</header>
            
            <main class="flex-1 overflow-y-auto p-4 bg-gray-50">
                <div id="clientes-section">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Lista de Clientes</h2>
                        <div>
                            <select id="filter-status" class="border rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="all">Todos los estados</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="contactado">Contactado</option>
                                <option value="no-contesto">No contestó</option>
                                <option value="vendido">Vendido</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacto</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asesor</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Última acción</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="clientes-list" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="nuevo-cliente-section" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Nuevo Cliente</h2>
                        <button id="cancel-new-client" class="text-sm text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times mr-1"></i> Cancelar
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <form id="nuevo-cliente-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre completo *</label>
                                    <input type="text" id="nombre" name="nombre" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="empresa" class="block text-sm font-medium text-gray-700 mb-1">Empresa</label>
                                    <input type="text" id="empresa" name="empresa" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                                    <input type="tel" id="telefono" name="telefono" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="celular" class="block text-sm font-medium text-gray-700 mb-1">Celular *</label>
                                    <input type="tel" id="celular" name="celular" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="correo" class="block text-sm font-medium text-gray-700 mb-1">Correo electrónico *</label>
                                    <input type="email" id="correo" name="correo" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="asesor" class="block text-sm font-medium text-gray-700 mb-1">Asesor de ventas *</label>
                                    <select id="asesor_id" name="asesor" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="">Seleccionar asesor</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="domicilio" class="block text-sm font-medium text-gray-700 mb-1">Domicilio</label>
                                    <textarea id="domicilio" name="domicilio" rows="2" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                </div>
                               
 <!-- REEMPLAZA COMPLETAMENTE la sección del documento CFE con esto: -->
<div>
    <label class="block text-sm font-medium text-gray-700 mb-2">
        Documento de apoyo de CFE *
        <span class="text-xs text-gray-500 font-normal">(Recibo CFE, identificación, etc.)</span>
    </label>
    
    <!-- Campo oculto para guardar la URL de ImgBB -->
    <input type="hidden" id="imgbb-url" name="imgbb_url" required>
    
    <!-- Vista previa del documento -->
    <div id="document-preview" class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center">
                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                <span class="text-sm font-medium text-gray-700">Documento listo</span>
            </div>
            <button type="button" id="remove-document-btn" class="text-red-500 hover:text-red-700 text-sm">
                <i class="fas fa-trash mr-1"></i>Eliminar
            </button>
        </div>
        <div id="preview-content" class="flex items-center space-x-3">
            <!-- Aquí se mostrará la imagen o icono del PDF -->
        </div>
        <a id="view-document-link" href="#" target="_blank" 
           class="inline-block mt-2 text-xs text-blue-600 hover:text-blue-800">
            <i class="fas fa-external-link-alt mr-1"></i>Abrir documento
        </a>
    </div>

    <!-- Área de subida -->
    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-400 transition-colors">
        <input type="file" id="document-upload" 
               accept=".pdf,.jpg,.jpeg,.png,.webp,.heic"
               class="hidden">
        
        <div id="upload-area" class="cursor-pointer">
            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
            <p class="text-sm text-gray-600 mb-1">
                <span class="font-medium text-indigo-600">Haz clic para subir</span> o arrastra tu archivo
            </p>
            <p class="text-xs text-gray-500">
                Formatos: PDF, JPG, PNG (Máx. 32MB)
            </p>
        </div>
        
        <div id="upload-progress" class="hidden mt-4">
            <div class="flex items-center justify-center space-x-2">
                <i class="fas fa-spinner fa-spin text-indigo-600"></i>
                <span class="text-sm text-gray-600">Subiendo...</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Información adicional -->
    <div class="mt-3 bg-blue-50 border border-blue-200 rounded-md p-3">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-2"></i>
            <div class="text-xs text-blue-700">
                <p class="font-medium">¿Qué documentos puedo subir?</p>
                <ul class="mt-1 list-disc list-inside space-y-1">
                    <li>Recibo de CFE (foto o PDF)</li>
                    <li>Identificación oficial (INE, pasaporte)</li>
                    <li>Comprobante de domicilio</li>
                    <li>Otros documentos del proyecto</li>
                </ul>
            </div>
        </div>
    </div>
</div>
                                <div class="md:col-span-2">
                                    <label for="razonSocial" class="block text-sm font-medium text-gray-700 mb-1">Razón Social *</label>
                                    <input type="text" id="razonSocial" name="razonSocial" placeholder="Ejemplo: SOLAREVER S.A. de C.V." required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <div class="md:col-span-2">
                                    <label for="descripcionProyecto" class="block text-sm font-medium text-gray-700 mb-1">Descripción del Proyecto</label>
                                    <textarea id="descripcionProyecto" name="descripcionProyecto" rows="2" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                </div>
                               <div>
    <span class="block text-sm font-medium text-gray-700 mb-1">Tipo de Sistema</span>
    <div class="mt-2 space-y-2">
        <label class="inline-flex items-center">
            <input type="checkbox" name="tipoSistema" value="fotovoltaico" class="form-checkbox text-indigo-600">
            <span class="ml-2 text-gray-700">Fotovoltaico</span>
        </label>
        <label class="inline-flex items-center ml-4">
            <input type="checkbox" name="tipoSistema" value="almacenamiento" class="form-checkbox text-indigo-600">
            <span class="ml-2 text-gray-700">Almacenamiento</span>
        </label>
    </div>
</div>
                                <div>
                                    <label for="tipoProyecto" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Proyecto</label>
                                    <input type="text" id="tipoProyecto" name="tipoProyecto" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="ubicacion" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                                    <input type="text" id="ubicacion" name="ubicacion" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="cedis" class="block text-sm font-medium text-gray-700 mb-1">CEDIS</label>
                                    <input type="text" id="cedis" name="cedis" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="consumoPromedio" class="block text-sm font-medium text-gray-700 mb-1">Consumo Promedio</label>
                                    <input type="number" id="consumoPromedio" name="consumoPromedio" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="ahorroEsperado" class="block text-sm font-medium text-gray-700 mb-1">Porcentaje de Ahorro Esperado</label>
                                    <input type="number" id="ahorroEsperado" name="ahorroEsperado" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>

                            </div>
                            <div class="mt-6 flex justify-end">
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                    <i class="fas fa-save mr-2"></i> Guardar Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="editar-cliente-section" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Editar Cliente</h2>
                        <button id="cancel-edit-client" class="text-sm text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times mr-1"></i> Cancelar
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <form id="editar-cliente-form">
                            <input type="hidden" id="edit-id" name="id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="edit-nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre completo *</label>
                                    <input type="text" id="edit-nombre" name="nombre" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="edit-empresa" class="block text-sm font-medium text-gray-700 mb-1">Empresa</label>
                                    <input type="text" id="edit-empresa" name="empresa" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="edit-telefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                                    <input type="tel" id="edit-telefono" name="telefono" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="edit-celular" class="block text-sm font-medium text-gray-700 mb-1">Celular *</label>
                                    <input type="tel" id="edit-celular" name="celular" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="edit-correo" class="block text-sm font-medium text-gray-700 mb-1">Correo electrónico *</label>
                                    <input type="email" id="edit-correo" name="correo" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="edit-asesor" class="block text-sm font-medium text-gray-700 mb-1">Asesor de ventas *</label>
                                    <select id="edit-asesor" name="asesor" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="">Seleccionar asesor</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="edit-domicilio" class="block text-sm font-medium text-gray-700 mb-1">Domicilio</label>
                                    <textarea id="edit-domicilio" name="domicilio" rows="2" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="edit-status" class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                    <select id="edit-status" name="status" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="pendiente">Pendiente</option>
                                        <option value="contactado">Contactado</option>
                                        <option value="no-contesto">No contestó</option>
                                        <option value="vendido">Vendido</option>
                                    </select>
                                </div>
                               <div class="md:col-span-2">
    <label class="block text-sm font-medium text-gray-700 mb-2">
        Documento de apoyo de CFE
        <span class="text-xs text-gray-500 font-normal">(Recibo CFE, identificación, etc.)</span>
    </label>
    
    <input type="hidden" id="edit-imgbb-url" name="imgbb_url">
    <!-- Campo oculto para link_cfe: algunas rutinas esperan este campo al cargar cliente -->
    <input type="hidden" id="edit-link-cfe" name="link_cfe">
    
    <div id="edit-document-preview" class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center">
                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                <span class="text-sm font-medium text-gray-700">Documento listo</span>
            </div>
            <button type="button" id="edit-remove-document-btn" class="text-red-500 hover:text-red-700 text-sm">
                <i class="fas fa-trash mr-1"></i>Eliminar
            </button>
        </div>
        <div id="edit-preview-content" class="flex items-center space-x-3">
            </div>
        <a id="edit-view-document-link" href="#" target="_blank" 
           class="inline-block mt-2 text-xs text-blue-600 hover:text-blue-800">
            <i class="fas fa-external-link-alt mr-1"></i>Abrir documento
        </a>
    </div>

    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-400 transition-colors">
        <input type="file" id="edit-document-upload" 
               accept=".pdf,.jpg,.jpeg,.png,.webp,.heic"
               class="hidden">
        
        <div id="edit-upload-area" class="cursor-pointer">
            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
            <p class="text-sm text-gray-600 mb-1">
                <span class="font-medium text-indigo-600">Haz clic para subir</span> o arrastra tu archivo
            </p>
            <p class="text-xs text-gray-500">
                Formatos: PDF, JPG, PNG (Máx. 32MB)
            </p>
        </div>
        
        <div id="edit-upload-progress" class="hidden mt-4">
            <div class="flex items-center justify-center space-x-2">
                <i class="fas fa-spinner fa-spin text-indigo-600"></i>
                <span class="text-sm text-gray-600">Subiendo...</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                <div id="edit-progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>
                                <div class="md:col-span-2">
                                    <label for="edit-razonSocial" class="block text-sm font-medium text-gray-700 mb-1">Razón Social *</label>
                                    <input type="text" id="edit-razonSocial" name="razonSocial" placeholder="Ejemplo: SOLAREVER S.A. de C.V." required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                            <div class="md:col-span-2">
                            <label for="edit-descripcionProyecto" class="block text-sm font-medium text-gray-700 mb-1">Descripción del Proyecto</label>
                            <textarea id="edit-descripcionProyecto" name="descripcionProyecto" rows="2" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                        <div>
    <span class="block text-sm font-medium text-gray-700 mb-1">Tipo de Sistema</span>
    <div class="mt-2 space-y-2">
        <label class="inline-flex items-center">
            <input type="checkbox" id="edit-tipoSistema-fotovoltaico" name="tipoSistema" value="fotovoltaico" class="form-checkbox text-indigo-600">
            <span class="ml-2 text-gray-700">Fotovoltaico</span>
        </label>
        <label class="inline-flex items-center ml-4">
            <input type="checkbox" id="edit-tipoSistema-almacenamiento" name="tipoSistema" value="almacenamiento" class="form-checkbox text-indigo-600">
            <span class="ml-2 text-gray-700">Almacenamiento</span>
        </label>
    </div>
</div>
                        <div>
                            <label for="edit-tipoProyecto" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Proyecto</label>
                            <input type="text" id="edit-tipoProyecto" name="tipoProyecto" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="edit-ubicacion" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                            <input type="text" id="edit-ubicacion" name="ubicacion" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="edit-cedis" class="block text-sm font-medium text-gray-700 mb-1">CEDIS</label>
                            <input type="text" id="edit-cedis" name="cedis" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="edit-consumoPromedio" class="block text-sm font-medium text-gray-700 mb-1">Consumo Promedio</label>
                            <input type="number" id="edit-consumoPromedio" name="consumoPromedio" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="edit-ahorroEsperado" class="block text-sm font-medium text-gray-700 mb-1">Porcentaje de Ahorro Esperado</label>
                            <input type="number" id="edit-ahorroEsperado" name="ahorroEsperado" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>

                            <div class="mt-6 flex justify-end">
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                    <i class="fas fa-save mr-2"></i> Guardar Cambios
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-10">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Historial de Interacciones</h3>
                                <button id="add-interaction" class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center">
                                    <i class="fas fa-plus-circle mr-1"></i> Agregar
                                </button>
                            </div>
                            
                            <div id="interacciones-list" class="space-y-4">
                                </div>
                        </div>
                    </div>
                </div>
                
                <div id="interaction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Agregar Interacción</h3>
                            <button id="close-interaction-modal" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="nueva-interaccion-form">
                            <input type="hidden" id="interaction-cliente-id" name="cliente_id">
                            <div class="space-y-4">
                                <div>
                                    <label for="tipo-interaccion" class="block text-sm font-medium text-gray-700 mb-1">Tipo *</label>
                                    <select id="tipo-interaccion" name="tipo" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="">Seleccionar tipo</option>
                                        <option value="llamada">Llamada</option>
                                        <option value="correo">Correo</option>
                                        <option value="reunion">Reunión</option>
                                        <option value="cotizacion">Cotización</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="fecha-interaccion" class="block text-sm font-medium text-gray-700 mb-1">Fecha *</label>
                                    <input type="datetime-local" id="fecha-interaccion" name="fecha" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="notas-interaccion" class="block text-sm font-medium text-gray-700 mb-1">Notas *</label>
                                    <textarea id="notas-interaccion" name="notas" rows="3" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                </div>
                                <div>
                                    <label for="resultado-interaccion" class="block text-sm font-medium text-gray-700 mb-1">Resultado</label>
                                    <select id="resultado-interaccion" name="resultado" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="">Sin resultado</option>
                                        <option value="pendiente">Pendiente</option>
                                        <option value="contactado">Contactado</option>
                                        <option value="no-contesto">No contestó</option>
                                        <option value="vendido">Vendido</option>
                                        <option value="cotizacion-enviada">Cotización enviada</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end space-x-3">
                                <button type="button" id="cancel-interaction" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                    Guardar Interacción
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="informe-section" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Informes y Estadísticas</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Total Clientes</p>
                                    <h3 id="total-clientes" class="text-3xl font-bold mt-2">0</h3>
                                </div>
                                <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600">
                                    <i class="fas fa-users text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Clientes Nuevos</p>
                                    <h3 id="nuevos-clientes" class="text-3xl font-bold mt-2">0</h3>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                                    <i class="fas fa-user-plus text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Tasa de Conversión</p>
                                    <h3 id="tasa-conversion" class="text-3xl font-bold mt-2">0%</h3>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                                    <i class="fas fa-chart-line text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-semibold">Clientes por Estado</h3>
                                <select id="report-period" class="border rounded-md px-2 py-1 text-sm">
                                    <option value="week">Esta semana</option>
                                    <option value="month">Este mes</option>
                                    <option value="quarter">Este trimestre</option>
                                    <option value="year">Este año</option>
                                </select>
                            </div>
                            <canvas id="status-chart" height="200"></canvas>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="font-semibold mb-4">Ventas por Asesor</h3>
                            <canvas id="asesor-chart" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow mt-6 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold mb-2">Interacciones Recientes</h3>
<table class="table-auto w-full border-collapse border border-gray-300">
  <thead>
    <tr>
      <th class="border border-gray-300 px-2 py-1">Cliente</th>
      <th class="border border-gray-300 px-2 py-1">Tipo</th>
      <th class="border border-gray-300 px-2 py-1">Fecha</th>
      <th class="border border-gray-300 px-2 py-1">Resultado</th>
      <th class="border border-gray-300 px-2 py-1">Notas</th>
    </tr>
  </thead>
  <tbody id="recent-interactions"></tbody>
</table>

                        </div>
                    </div>
                </div>
                
                <div id="asesores-section" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Gestión de Asesores</h2>
                        <button id="add-asesor" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 text-sm">
                            <i class="fas fa-plus mr-2"></i> Nuevo Asesor
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Correo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clientes</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ventas</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="asesores-list" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="asesor-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Nuevo Asesor</h3>
                            <button id="close-asesor-modal" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form id="nuevo-asesor-form">
                            <div class="space-y-4">
                                <div>
                                    <label for="asesor-nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre completo *</label>
                                    <input type="text" id="asesor-nombre" name="nombre" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="asesor-correo" class="block text-sm font-medium text-gray-700 mb-1">Correo electrónico *</label>
                                    <input type="email" id="asesor-correo" name="correo" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="asesor-telefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono *</label>
                                    <input type="tel" id="asesor-telefono" name="telefono" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="asesor-fechaIngreso" class="block text-sm font-medium text-gray-700 mb-1">Fecha de ingreso *</label>
                                    <input type="date" id="asesor-fechaIngreso" name="fechaIngreso" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end space-x-3">
                                <button type="button" id="cancel-asesor" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                    Guardar Asesor
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- En nuevo - copia.html - Después de la sección de asesores -->
<div id="reportes-pdf-section" class="hidden">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Reportes PDF de Clientes</h2>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <!-- Selector de período -->
        <div class="mb-6">
            <label for="reporte-periodo" class="block text-sm font-medium text-gray-700 mb-2">
                Seleccionar Período del Reporte
            </label>
            <select id="reporte-periodo" class="w-full md:w-64 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="semana">Esta Semana</option>
                <option value="mes">Este Mes</option>
                <option value="trimestre">Este Trimestre</option>
                <option value="ano">Este Año</option>
                <option value="personalizado">Personalizado</option>
            </select>
        </div>

        <!-- Selector de fecha personalizada -->
        <div id="fechas-personalizadas" class="hidden mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="fecha-inicio" class="block text-sm font-medium text-gray-700 mb-1">
                        Fecha Inicio
                    </label>
                    <input type="date" id="fecha-inicio" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="fecha-fin" class="block text-sm font-medium text-gray-700 mb-1">
                        Fecha Fin
                    </label>
                    <input type="date" id="fecha-fin" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
        </div>

        <!-- Filtros adicionales -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label for="filtro-estado" class="block text-sm font-medium text-gray-700 mb-1">
                    Filtrar por Estado
                </label>
                <select id="filtro-estado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="todos">Todos los estados</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="contactado">Contactado</option>
                    <option value="no-contesto">No contestó</option>
                    <option value="vendido">Vendido</option>
                </select>
            </div>
            
            <div>
                <label for="filtro-asesor" class="block text-sm font-medium text-gray-700 mb-1">
                    Filtrar por Asesor
                </label>
                <select id="filtro-asesor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="todos">Todos los asesores</option>
                </select>
            </div>

            <div>
                <label for="orden-reporte" class="block text-sm font-medium text-gray-700 mb-1">
                    Ordenar por
                </label>
                <select id="orden-reporte" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="fecha_creacion">Fecha de creación</option>
                    <option value="nombre">Nombre del cliente</option>
                    <option value="estado">Estado</option>
                    <option value="asesor">Asesor</option>
                </select>
            </div>
        </div>

        <!-- Vista previa del reporte -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Vista Previa del Reporte</h3>
                <button id="actualizar-vista-previa" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm">
                    <i class="fas fa-sync-alt mr-2"></i> Actualizar Vista
                </button>
            </div>
            
            <div id="vista-previa-reporte" class="border border-gray-200 rounded-lg p-4 bg-gray-50 min-h-200">
                <p class="text-gray-500 text-center py-8">Selecciona un período y haz clic en "Actualizar Vista" para previsualizar el reporte</p>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="flex justify-end space-x-3">
            <button id="generar-pdf" class="px-6 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 flex items-center">
                <i class="fas fa-file-pdf mr-2"></i> Generar PDF
            </button>
        </div>
    </div>
</div>
<!-- En nuevo - copia.html - Después de la sección reportes-pdf-section -->
<div id="auditoria-section" class="hidden">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Auditoría de Cambios</h2>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <!-- Selector de período -->
        <div class="mb-6">
            <label for="auditoria-periodo" class="block text-sm font-medium text-gray-700 mb-2">
                Seleccionar Período
            </label>
            <select id="auditoria-periodo" class="w-full md:w-64 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="hoy">Hoy</option>
                <option value="semana">Esta Semana</option>
                <option value="mes">Este Mes</option>
                <option value="trimestre">Este Trimestre</option>
                <option value="ano">Este Año</option>
                <option value="personalizado">Personalizado</option>
            </select>
        </div>

        <!-- Selector de fecha personalizada -->
        <div id="auditoria-fechas-personalizadas" class="hidden mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="auditoria-fecha-inicio" class="block text-sm font-medium text-gray-700 mb-1">
                        Fecha Inicio
                    </label>
                    <input type="date" id="auditoria-fecha-inicio" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="auditoria-fecha-fin" class="block text-sm font-medium text-gray-700 mb-1">
                        Fecha Fin
                    </label>
                    <input type="date" id="auditoria-fecha-fin" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
        </div>

        <!-- Filtros adicionales -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div>
                <label for="filtro-accion" class="block text-sm font-medium text-gray-700 mb-1">
                    Tipo de Acción
                </label>
                <select id="filtro-accion" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="todos">Todas las acciones</option>
                    <option value="crear">Creación</option>
                    <option value="actualizar">Actualización</option>
                    <option value="eliminar">Eliminación</option>
                </select>
            </div>
            
            <div>
                <label for="filtro-usuario" class="block text-sm font-medium text-gray-700 mb-1">
                    Usuario
                </label>
                <select id="filtro-usuario" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="todos">Todos los usuarios</option>
                </select>
            </div>

            <div>
                <label for="filtro-cliente" class="block text-sm font-medium text-gray-700 mb-1">
                    Cliente
                </label>
                <select id="filtro-cliente" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="todos">Todos los clientes</option>
                </select>
            </div>

            <div>
                <label for="orden-auditoria" class="block text-sm font-medium text-gray-700 mb-1">
                    Ordenar por
                </label>
                <select id="orden-auditoria" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="fecha_desc">Fecha (Más reciente)</option>
                    <option value="fecha_asc">Fecha (Más antigua)</option>
                    <option value="usuario">Usuario</option>
                    <option value="cliente">Cliente</option>
                    <option value="accion">Acción</option>
                </select>
            </div>
        </div>

        <!-- Vista previa del reporte de auditoría -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Vista Previa de Auditoría</h3>
                <button id="actualizar-auditoria" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm">
                    <i class="fas fa-sync-alt mr-2"></i> Actualizar Vista
                </button>
            </div>
            
            <div id="vista-previa-auditoria" class="border border-gray-200 rounded-lg p-4 bg-gray-50 min-h-200">
                <p class="text-gray-500 text-center py-8">Selecciona un período y haz clic en "Actualizar Vista" para previsualizar la auditoría</p>
            </div>
        </div>

        <!-- Estadísticas rápidas -->
        <div id="estadisticas-auditoria" class="hidden mb-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600" id="total-cambios">0</div>
                    <div class="text-sm text-blue-800">Total Cambios</div>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-600" id="total-creaciones">0</div>
                    <div class="text-sm text-green-800">Creaciones</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-yellow-600" id="total-actualizaciones">0</div>
                    <div class="text-sm text-yellow-800">Actualizaciones</div>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-red-600" id="total-eliminaciones">0</div>
                    <div class="text-sm text-red-800">Eliminaciones</div>
                </div>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="flex justify-end space-x-3">
            <button id="generar-pdf-auditoria" class="px-6 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 flex items-center">
                <i class="fas fa-file-pdf mr-2"></i> Generar PDF
            </button>
        </div>
    </div>
</div>
            </main>
        </div>
    </div>

<script>
    // ========================================
// FUNCIONES DE PERMISOS DE USUARIO
// ========================================

// Verificar permisos del usuario logueado
function obtenerUsuarioLogueado() {
    const usuario = JSON.parse(localStorage.getItem('usuario_logeado'));
    const token = localStorage.getItem('crm_token');
    return { usuario, token };
}

// Verificar si el usuario puede ver asesores
function puedeVerAsesores() {
    const { usuario } = obtenerUsuarioLogueado();
    return usuario && usuario.role !== 'restricted';
}

// Verificar si el usuario puede modificar asesores
function puedeModificarAsesores() {
    const { usuario } = obtenerUsuarioLogueado();
    return usuario && usuario.role === 'admin';
}

// Aplicar permisos al cargar la página
// Aplicar permisos al cargar la página
function aplicarPermisosUsuario() {
    const { usuario } = obtenerUsuarioLogueado();
    
    if (!usuario) return;
    
    console.log('Aplicando permisos para rol:', usuario.role);
    
    // Ocultar/mostrar elementos según permisos
    const navAsesores = document.getElementById('nav-asesores');
    const navAuditoria = document.getElementById('nav-auditoria');
    const btnAddAsesor = document.getElementById('add-asesor');
    
    if (usuario.role === 'restricted') {
        // Ocultar completamente asesores y auditoría
        if (navAsesores) navAsesores.style.display = 'none';
        if (navAuditoria) navAuditoria.style.display = 'none';
        if (btnAddAsesor) btnAddAsesor.style.display = 'none';
        
        console.log('Usuario restricted - Secciones asesores y auditoría ocultas');
    } else if (usuario.role === 'asesor') {
        // Asesor puede ver asesores pero no auditoría, y no puede modificar
        if (navAuditoria) navAuditoria.style.display = 'none';
        if (btnAddAsesor) btnAddAsesor.style.display = 'none';
        console.log('Usuario asesor - Solo vista de asesores, auditoría oculta');
    }
    // Admin ve todo (no se oculta nada)
}
    // Variables globales
    let clientes = [];
    let asesores = [];
    let interacciones = [];
    let API_BASE_URL = 'http://localhost:3000'; // Ajusta según tu configuración
    
   document.addEventListener('DOMContentLoaded', function() {
    // Verificar autenticación
    const { usuario, token } = obtenerUsuarioLogueado();
    
    if (!usuario && !token) {
        window.location.href = 'login.html';
        return;
    }
    
    console.log('Usuario logueado:', usuario);
    
    // Inicializar aplicación
    setupMenu();
    setupForms();
    cargarDatos(); // Cargar datos después de verificar autenticación
    
    // Aplicar permisos inmediatamente
    aplicarPermisosUsuario();
    
    mostrarSeccion('clientes-section');
    document.getElementById('page-title').textContent = 'Clientes';
});
    // Inicialización de la aplicación
    document.addEventListener('DOMContentLoaded', function() {
    const loginScreen = document.getElementById('login-screen');
    const mainPanel = document.getElementById('main-panel');
    
    // Verificar si ya está logueado
    if (localStorage.getItem('crm_token') && loginScreen && mainPanel) {
        loginScreen.classList.add('hidden');
        mainPanel.classList.remove('hidden');
        cargarDatos();
    }
     // ✅ AGREGAR ESTE BLOQUE: Cargar documento del localStorage
    const ultimaImagen = localStorage.getItem('ultimoDocumentoCFE');
    if (ultimaImagen) {
        const previewDiv = document.getElementById('document-preview');
        const previewContent = document.getElementById('preview-content');
        const viewLink = document.getElementById('view-document-link');

        // Mostrar vista previa
        previewContent.innerHTML = `
            <img src="${ultimaImagen}" alt="Documento CFE" class="h-24 rounded shadow">
        `;
        viewLink.href = ultimaImagen;
        previewDiv.classList.remove('hidden');

        // Rellenar el campo oculto con la URL
        document.getElementById('imgbb-url').value = ultimaImagen;
    }
    
        
        // Inicializar menú
        setupMenu();
        
        // Inicializar eventos de formularios
        setupForms();
        
        // Mostrar vista por defecto
        mostrarSeccion('clientes-section');
        document.getElementById('page-title').textContent = 'Clientes';
        document.getElementById('search-clientes').addEventListener('input', actualizarListaClientes);

        // Inicializar gráficos
        actualizarInformes();
    });
    
    // ========================================
    // FUNCIONES DE CONEXIÓN CON EL BACKEND
    // ========================================
    
    // Función para hacer peticiones autenticadas
    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('crm_token');
        
        if (!options.headers) {
            options.headers = {};
        }
        
        options.headers['Authorization'] = `Bearer ${token}`;
        options.headers['Content-Type'] = 'application/json';
        
        const response = await fetch(url, options);
        
        if (response.status === 401) {
            // Token expirado o inválido
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.reload();
            return null;
        }
        
        return response;
    }
    // Función faltante - agregar al script principal
// Función para cargar asesores - CON MANEJO DE PERMISOS
// Función para cargar asesores - VERSIÓN MEJORADA
async function cargarAsesores() {
    try {
        console.log('🔄 Cargando asesores...');
        
        const token = localStorage.getItem('crm_token');
        if (!token) {
            console.warn('No hay token de autenticación');
            return;
        }

        const response = await fetch(`${API_BASE_URL}/api/asesores`, {
            headers: { 
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        });
        
        console.log('📡 Respuesta de asesores - Status:', response.status);
        
        if (response.status === 403) {
            console.warn('Usuario no tiene permisos para ver asesores');
            asesores = [];
            actualizarOpcionesAsesores();
            return;
        }
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('📊 Resultado de asesores:', result);
        
        if (result.success) {
            asesores = result.data || [];
            console.log(`✅ ${asesores.length} asesores cargados`);
            actualizarOpcionesAsesores();
            actualizarListaAsesores();
        } else {
            console.error('Error al obtener asesores:', result.message);
            asesores = [];
        }
    } catch (error) {
        console.error('❌ Error de conexión al cargar asesores:', error);
        asesores = [];
        mostrarMensaje('Error al cargar asesores', 'error');
    }
}
    
    // Cargar datos del backend// Cargar datos del backend
// En la función cargarDatos(), después de cargar clientes y asesores:
// Cargar datos del backend - CON MANEJO DE PERMISOS
// Cargar datos del backend - VERSIÓN CORREGIDA
async function cargarDatos() {
    try {
        console.log('🔄 Cargando datos iniciales...');
        
        // Cargar asesores PRIMERO
        await cargarAsesores();
        
        // Cargar clientes
        const clientesResponse = await fetchWithAuth(`${API_BASE_URL}/api/clientes`);
        if (clientesResponse && clientesResponse.ok) {
            const data = await clientesResponse.json();
            clientes = data.data;
            console.log(`✅ ${clientes.length} clientes cargados`);
        } else if (clientesResponse && clientesResponse.status === 403) {
            console.warn('Permiso denegado para cargar clientes');
            mostrarMensaje('No tienes permisos para ver clientes', 'error');
        }
        
        // Actualizar listas
        actualizarListaClientes();
        
        // Aplicar permisos después de cargar datos
        aplicarPermisosUsuario();
        
        console.log('✅ Datos cargados exitosamente');
        
    } catch (error) {
        console.error('❌ Error al cargar datos:', error);
        mostrarMensaje('Error al cargar datos', 'error');
    }
}
    // Función actualizada para actualizar informes
async function actualizarInformes() {
    if (!clientes || clientes.length === 0) {
        console.warn('No hay datos de clientes para generar informes');
        return;
    }

    // ... (código existente de gráficos) ...

    // ACTUALIZAR TABLA DE INTERACCIONES RECIENTES
    await actualizarTablaInteraccionesRecientes();
}

// Nueva función para actualizar la tabla de interacciones con Notas
async function actualizarTablaInteraccionesRecientes() {
    const tbody = document.getElementById('recent-interactions');
    if (!tbody) return;

    // Mostrar loading
    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">Cargando interacciones...</td></tr>';

    try {
        const interaccionesRecientes = await obtenerInteraccionesRecientes(10);
        
        if (interaccionesRecientes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No hay interacciones recientes</td></tr>';
            return;
        }

        // Generar las filas de la tabla
        tbody.innerHTML = interaccionesRecientes.map(interaccion => {
            const fecha = new Date(interaccion.fecha);
            const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const tipoText = {
                'llamada': 'Llamada',
                'correo': 'Correo',
                'reunion': 'Reunión',
                'cotizacion': 'Cotización'
            };

            const resultadoText = {
                'pendiente': 'Pendiente',
                'contactado': 'Contactado',
                'no-contesto': 'No contestó',
                'vendido': 'Vendido',
                'cotizacion-enviada': 'Cotización enviada'
            };

            const resultadoClass = {
                'pendiente': 'bg-orange-100 text-orange-800',
                'contactado': 'bg-purple-100 text-purple-800',
                'no-contesto': 'bg-red-100 text-red-800',
                'vendido': 'bg-green-300 text-green-900',
                'cotizacion-enviada': 'bg-pink-100 text-pink-800'
            };

            return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${interaccion.cliente_nombre || `Cliente #${interaccion.cliente_id}`}</div>
                        <div class="text-sm text-gray-500">${interaccion.cliente_empresa || 'Sin empresa'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm text-gray-900 capitalize">${tipoText[interaccion.tipo] || interaccion.tipo}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${fechaFormateada}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${interaccion.resultado ? 
                            `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${resultadoClass[interaccion.resultado] || 'bg-gray-100 text-gray-800'}">
                                ${resultadoText[interaccion.resultado] || interaccion.resultado}
                            </span>` : 
                            '<span class="text-sm text-gray-400">Sin resultado</span>'
                        }
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-700">
                        ${interaccion.notas || '-'}
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error al cargar interacciones recientes:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error al cargar interacciones</td></tr>';
    }
}

    
    // Actualizar cliente
// Actualizar cliente - CON MÁS LOGGING
async function actualizarCliente(id, clienteData) {
    try {
        console.log('=== ENVIANDO ACTUALIZACIÓN ===');
        console.log('Cliente ID:', id);
        console.log('Datos a enviar:', clienteData);
        
        const token = localStorage.getItem('crm_token');
        console.log('Token disponible:', !!token);
        
        const response = await fetch(`${API_BASE_URL}/api/clientes/${id}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(clienteData)
        });
        
        console.log('Respuesta del servidor - Status:', response.status);
        console.log('Respuesta del servidor - OK:', response.ok);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Respuesta exitosa:', data);
            return data.data;
        } else {
            const errorText = await response.text();
            console.error('Error del servidor - Texto:', errorText);
            
            try {
                const errorData = JSON.parse(errorText);
                throw new Error(errorData.message || `Error ${response.status}: ${response.statusText}`);
            } catch (e) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
        }
    } catch (error) {
        console.error('Error completo en actualizarCliente:', error);
        mostrarMensaje(`Error: ${error.message}`, 'error');
        return null;
    }
}
// Crear nuevo cliente
async function crearCliente(clienteData) {
    try {
        const token = localStorage.getItem('crm_token');
        console.log('=== CREANDO NUEVO CLIENTE ===');
        console.log('Datos a enviar:', clienteData);
        
        const response = await fetch(`${API_BASE_URL}/api/clientes`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(clienteData)
        });
        
        console.log('Respuesta del servidor - Status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Cliente creado exitosamente:', data);
            return data.data;
        } else {
            const errorText = await response.text();
            console.error('Error del servidor:', errorText);
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error al crear cliente:', error);
        mostrarMensaje(`Error: ${error.message}`, 'error');
        return null;
    }
}
    // Eliminar cliente
    async function eliminarClienteAPI(id) {
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/clientes/${id}`, {
                method: 'DELETE'
            });
            
            return response && response.ok;
        } catch (error) {
            console.error('Error al eliminar cliente:', error);
            return false;
        }
    }
    
    // Crear nuevo asesor
    async function crearAsesor(asesorData) {
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/asesores`, {
                method: 'POST',
                body: JSON.stringify(asesorData)
            });
            
            if (response && response.ok) {
                const data = await response.json();
                return data.data;
            }
            return null;
        } catch (error) {
            console.error('Error al crear asesor:', error);
            return null;
        }
    }
    
    // Actualizar asesor
    async function actualizarAsesor(id, asesorData) {
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/asesores/${id}`, {
                method: 'PUT',
                body: JSON.stringify(asesorData)
            });
            
            if (response && response.ok) {
                const data = await response.json();
                return data.data;
            }
            return null;
        } catch (error) {
            console.error('Error al actualizar asesor:', error);
            return null;
        }
    }
    
    // Eliminar asesor
    async function eliminarAsesorAPI(id) {
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/asesores/${id}`, {
                method: 'DELETE'
            });
            
            return response && response.ok;
        } catch (error) {
            console.error('Error al eliminar asesor:', error);
            return false;
        }
    }
    
    // Crear interacción
    async function crearInteraccion(interaccionData) {
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/interacciones`, {
                method: 'POST',
                body: JSON.stringify(interaccionData)
            });
            
            if (response && response.ok) {
                const data = await response.json();
                return data.data;
            }
            return null;
        } catch (error) {
            console.error('Error al crear interacción:', error);
            return null;
        }
    }
    // Función para obtener todas las interacciones recientes
async function obtenerInteraccionesRecientes(limite = 10) {
    try {
        // Como no tenemos un endpoint para todas las interacciones, 
        // vamos a obtenerlas cliente por cliente
        let todasInteracciones = [];
        
        // Obtener todos los clientes primero
        const clientesResponse = await fetchWithAuth(`${API_BASE_URL}/api/clientes`);
        if (clientesResponse && clientesResponse.ok) {
            const data = await clientesResponse.json();
            const todosClientes = data.data;
            
            // Para cada cliente, obtener sus interacciones
            for (const cliente of todosClientes.slice(0, 10)) { // Limitar para no sobrecargar
                const interacciones = await obtenerInteraccionesCliente(cliente.id);
                interacciones.forEach(interaccion => {
                    interaccionesConCliente = {
                        ...interaccion,
                        cliente_nombre: cliente.nombre,
                        cliente_empresa: cliente.empresa
                    };
                    todasInteracciones.push(interaccionesConCliente);
                });
            }
            
            // Ordenar por fecha (más recientes primero) y limitar
            todasInteracciones.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            return todasInteracciones.slice(0, limite);
        }
        
        return [];
    } catch (error) {
        console.error('Error al obtener interacciones recientes:', error);
        return [];
    }

    try {
        const response = await fetchWithAuth(`${API_BASE_URL}/api/interacciones?limit=${limite}`);
        
        if (response && response.ok) {
            const data = await response.json();
            return data.data;
        }
        return [];
    } catch (error) {
        console.error('Error al obtener interacciones recientes:', error);
        return [];
    }
}
    
    // Obtener interacciones de un cliente
    async function obtenerInteraccionesCliente(clienteId) {
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/interacciones/${clienteId}`);
            
            if (response && response.ok) {
                const data = await response.json();
                return data.data;
            }
            return [];
        } catch (error) {
            console.error('Error al obtener interacciones:', error);
            return [];
        }
    }
    
    // ========================================
    // FUNCIONES EXISTENTES MODIFICADAS
    // ========================================
    
    // Configurar menú
    function setupMenu() {
        // Mostrar/ocultar menú en móviles
        const menuToggle = document.getElementById('menu-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
            // Event listener para búsqueda en tiempo real
    const searchInput = document.getElementById('search-clientes');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            console.log('Buscando texto:', this.value);
            actualizarListaClientes();
        });
    }
    
    // Event listener para filtro de estado
    const filterStatus = document.getElementById('filter-status');
    if (filterStatus) {
        filterStatus.addEventListener('change', function() {
            console.log('Cambiando estado a:', this.value);
            actualizarListaClientes();
        });
    }
        
        menuToggle.addEventListener('click', function() {
            document.querySelector('.sidebar').classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        });
        
        sidebarOverlay.addEventListener('click', function() {
            document.querySelector('.sidebar').classList.remove('active');
            this.classList.remove('active');
        });
        
        // Eventos de navegación
        document.getElementById('nav-clientes').addEventListener('click', function(e) {
            e.preventDefault();
            mostrarSeccion('clientes-section');
            document.getElementById('page-title').textContent = 'Clientes';
            actualizarListaClientes();
        });
        
       document.getElementById('nav-informe').addEventListener('click', function(e) {
    e.preventDefault();
    mostrarSeccion('informe-section');
    document.getElementById('page-title').textContent = 'Informes';
    actualizarInformes(); // Asegurar que se actualicen los gráficos
});
        
   // En la función setupMenu(), modifica el evento de navegación a asesores:
document.getElementById('nav-asesores').addEventListener('click', function(e) {
    e.preventDefault();
    
    if (!puedeVerAsesores()) {
        mostrarMensaje('No tienes permisos para acceder a la sección de asesores', 'error');
        return;
    }
    
    mostrarSeccion('asesores-section');
    document.getElementById('page-title').textContent = 'Asesores';
    actualizarListaAsesores();
});
        
        // Cancelar edición
        document.getElementById('cancel-edit-client').addEventListener('click', function(e) {
            e.preventDefault();
            mostrarSeccion('clientes-section');
            document.getElementById('page-title').textContent = 'Clientes';
        });
        
        // Filtrar por estado
        document.getElementById('filter-status').addEventListener('change', function() {
            actualizarListaClientes();
        });
    }
    // Función de depuración - para verificar el estado de los datos
function verificarEstadoDatos() {
    console.log('=== ESTADO DE DATOS ===');
    console.log('Asesores:', asesores);
    console.log('Clientes:', clientes.length);
    console.log('Usuario logueado:', obtenerUsuarioLogueado().usuario);
    console.log('Token disponible:', !!localStorage.getItem('crm_token'));
    console.log('======================');
}

// Ejecutar depuración después de cargar
setTimeout(verificarEstadoDatos, 2000);
    
    // Configurar formularios
    function setupForms() {
        // Formulario nuevo cliente
        document.getElementById('nuevo-cliente-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validarFormularioCliente(this)) {
                return;
            }
            
            // En el formulario nuevo cliente - CORREGIDO
// En el <script> de index.html, dentro de nuevoClienteForm.addEventListener('submit', ...)

// Crear objeto con los datos del formulario
// En el <script> de index.html, dentro de nuevoClienteForm.addEventListener('submit', ...)

// Crear objeto con los datos del formulario
const clienteData = {
    nombre: document.getElementById('nombre').value,
    empresa: document.getElementById('empresa').value,
    telefono: document.getElementById('telefono').value,
    celular: document.getElementById('celular').value,
    correo: document.getElementById('correo').value,
    
    // ✅ CORRECCIÓN 1: ASESOR_ID
    // Se mantiene, ya que la lógica es correcta, el problema es la carga.
    asesor_id: parseInt(document.getElementById('asesor_id').value) || null,
    
    domicilio: document.getElementById('domicilio').value,
    razon_social: document.getElementById('razon-social').value, 
    descripcion_proyecto: document.getElementById('descripcion-proyecto').value, 
    
    // 🛑 CORRECCIÓN 2: TIPO DE SISTEMA
    // Se usa 'tipo-sistema' para coincidir con el atributo name del HTML.
    // Antes se usaba incorrectamente 'tipoSistema' (camelCase).
    tipo_sistema: Array.from(document.querySelectorAll('input[name="tipo-sistema"]:checked'))
                       .map(checkbox => checkbox.value)
                       .join(', '),
    // ✅ CORRECCIÓN: Obtener valor del radio button seleccionado (por name)
    tipo_proyecto: document.querySelector('input[name="tipo-proyecto"]:checked')?.value || null,
    
    // ✅ CORRECCIÓN DE ID: 'ubicacion-google-maps' en lugar de 'ubicacion'
    ubicacion: document.getElementById('ubicacion-google-maps').value, 
    
    // ✅ Agregar Tarifa CFE que estaba faltando
    tarifa_cfe: document.getElementById('tarifa-cfe').value,
    
    cedis: document.getElementById('cedis').value,
    
    // ✅ CORRECCIÓN DE ID: 'consumo-promedio' en lugar de 'consumoPromedio'
    consumo_promedio: parseFloat(document.getElementById('consumo-promedio').value) || 0,
    
    // ✅ CORRECCIÓN DE ID: 'porcentaje-ahorro' en lugar de 'ahorroEsperado'
    porcentaje_ahorro: parseFloat(document.getElementById('porcentaje-ahorro').value) || 0, 
    
    // ✅ Corrección: Asumir link_cfe no está en el HTML, pero debería. Usamos null si no existe.
    // Si necesitas subir el archivo, esta lógica debe cambiar
    link_cfe: document.getElementById('link-cfe')?.value || null, 
    imgbb_url: document.getElementById('imgbb-url').value,
    documento_subido: document.getElementById('imgbb-url').value ? 'si' : 'no',
    status: 'pendiente'
};
            const nuevoCliente = await crearCliente(clienteData);
            
            if (nuevoCliente) {
                mostrarMensaje('Cliente creado exitosamente', 'success');
                localStorage.removeItem('ultimoDocumentoCFE');
                this.reset();
                mostrarSeccion('clientes-section');
                document.getElementById('page-title').textContent = 'Clientes';
                await cargarDatos(); // Recargar datos
            } else {
                mostrarMensaje('Error al crear cliente', 'error');
            }
        });
        
    // En el archivo: nuevo - copia.html
// Busca el formulario de editar cliente y agrega esta funcionalidad:

// Formulario editar cliente - CON SINCRONIZACIÓN AUTOMÁTICA
document.getElementById('editar-cliente-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  if (!validarFormularioCliente(this)) {
    return;
  }
  
  const id = parseInt(document.getElementById('edit-id').value);
  
  // Construir objeto SIN el campo interes
  const clienteData = {};
  
  // Campos obligatorios
  clienteData.nombre = document.getElementById('edit-nombre').value;
  clienteData.celular = document.getElementById('edit-celular').value;
  clienteData.correo = document.getElementById('edit-correo').value;
  clienteData.asesor_id = parseInt(document.getElementById('edit-asesor').value);
  clienteData.status = document.getElementById('edit-status').value;
  clienteData.razon_social = document.getElementById('edit-razonSocial').value;
  
  // Campos opcionales - solo si tienen valor
  const empresa = document.getElementById('edit-empresa').value;
  if (empresa) clienteData.empresa = empresa;
  
  const telefono = document.getElementById('edit-telefono').value;
  if (telefono) clienteData.telefono = telefono;
  
  const domicilio = document.getElementById('edit-domicilio').value;
  if (domicilio) clienteData.domicilio = domicilio;
  
  const linkCfe = document.getElementById('edit-link-cfe').value;
  if (linkCfe) clienteData.link_cfe = linkCfe;
  
  const descProyecto = document.getElementById('edit-descripcionProyecto').value;
  if (descProyecto) clienteData.descripcion_proyecto = descProyecto;
  
  const tipoSistema = Array.from(document.querySelectorAll('input[name="tipoSistema"]:checked'))
                       .map(checkbox => checkbox.value)
                       .join(', ');
  if (tipoSistema) clienteData.tipo_sistema = tipoSistema;
  
  const tipoProyecto = document.getElementById('edit-tipoProyecto').value;
  if (tipoProyecto) clienteData.tipo_proyecto = tipoProyecto;
  
  const ubicacion = document.getElementById('edit-ubicacion').value;
  if (ubicacion) clienteData.ubicacion = ubicacion;
  
  const cedis = document.getElementById('edit-cedis').value;
  if (cedis) clienteData.cedis = cedis;
  
  const consumoPromedio = document.getElementById('edit-consumoPromedio').value;
  if (consumoPromedio) clienteData.consumo_promedio = parseFloat(consumoPromedio);
  
  const ahorroEsperado = document.getElementById('edit-ahorroEsperado').value;
  if (ahorroEsperado) clienteData.porcentaje_ahorro = parseFloat(ahorroEsperado);
  
  console.log('Datos a enviar para actualización:', clienteData);
  
  const clienteActualizado = await actualizarCliente(id, clienteData);
  
  if (clienteActualizado) {
    mostrarMensaje('Cliente actualizado exitosamente', 'success');
    
    // CREAR INTERACCIÓN AUTOMÁTICA CUANDO SE CAMBIA EL ESTADO
    const estadoAnterior = clientes.find(c => c.id === id)?.status;
    const estadoNuevo = clienteData.status;
    
    if (estadoAnterior && estadoAnterior !== estadoNuevo) {
      console.log('Estado cambiado, creando interacción automática');
      
      const interaccionData = {
        cliente_id: id,
        tipo: 'actualizacion',
        fecha: new Date().toISOString().slice(0, 16),
        notas: `Estado cambiado de "${estadoAnterior}" a "${estadoNuevo}"`,
        resultado: estadoNuevo
      };
      
      await crearInteraccion(interaccionData);
      
      // Recargar interacciones del cliente
      await cargarInteraccionesCliente(id);
    }
    
    // Recargar datos generales
    await cargarDatos();
    
    // Actualizar lista de clientes
    actualizarListaClientes();
    
    mostrarSeccion('clientes-section');
    document.getElementById('page-title').textContent = 'Clientes';
  }
  // Agrega esta función auxiliar para mejor legibilidad
function obtenerNombreEstado(status) {
  const estados = {
    'pendiente': 'Pendiente',
    'contactado': 'Contactado', 
    'no-contesto': 'No contestó',
    'vendido': 'Vendido'
  };
  return estados[status] || status;
}
});
        
        // Formulario nueva interacción
     // Formulario nueva interacción
// En el archivo: nuevo - copia.html
// Busca el formulario de nueva interacción y reemplázalo:

// Formulario nueva interacción - VERSIÓN MEJORADA CON SINCRONIZACIÓN
document.getElementById('nueva-interaccion-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const clienteId = parseInt(document.getElementById('interaction-cliente-id').value);
  const interaccionData = {
    cliente_id: clienteId,
    tipo: document.getElementById('tipo-interaccion').value,
    fecha: document.getElementById('fecha-interaccion').value,
    notas: document.getElementById('notas-interaccion').value,
    resultado: document.getElementById('resultado-interaccion').value
  };
  
  const nuevaInteraccion = await crearInteraccion(interaccionData);
  
  if (nuevaInteraccion) {
    // ACTUALIZAR ESTADO DEL CLIENTE SI SE SELECCIONÓ UN RESULTADO
    if (interaccionData.resultado && 
        ['pendiente', 'contactado', 'no-contesto', 'vendido'].includes(interaccionData.resultado)) {
      
      console.log('Actualizando estado del cliente a:', interaccionData.resultado);
      
      // Actualizar el estado del cliente
      const clienteData = { status: interaccionData.resultado };
      const clienteActualizado = await actualizarCliente(clienteId, clienteData);
      
      if (clienteActualizado) {
        console.log('Estado del cliente actualizado exitosamente');
        
        // ACTUALIZAR EL SELECTOR EN EL FORMULARIO DE EDICIÓN SI ESTÁ ABIERTO
        const editStatusSelect = document.getElementById('edit-status');
        if (editStatusSelect && document.getElementById('edit-id').value == clienteId) {
          editStatusSelect.value = interaccionData.resultado;
          console.log('Selector de estado actualizado en el formulario');
        }
      }
    }
    
    mostrarMensaje('Interacción registrada exitosamente', 'success');
    document.getElementById('interaction-modal').classList.add('hidden');
    
    // Recargar datos y vistas
    await cargarInteraccionesCliente(clienteId);
    await cargarDatos(); // Recargar datos generales
    
    // Actualizar lista de clientes si estamos en esa sección
    if (!document.getElementById('clientes-section').classList.contains('hidden')) {
      actualizarListaClientes();
    }
    
    this.reset();
  } else {
    mostrarMensaje('Error al registrar interacción', 'error');
  }
});
        
        // Cancelar interacción
        document.getElementById('cancel-interaction').addEventListener('click', function() {
            document.getElementById('interaction-modal').classList.add('hidden');
            document.getElementById('nueva-interaccion-form').reset();
        });
        
        // Cerrar modal interacción
        document.getElementById('close-interaction-modal').addEventListener('click', function() {
            document.getElementById('interaction-modal').classList.add('hidden');
            document.getElementById('nueva-interaccion-form').reset();
        });
        
        // Botón agregar interacción
        document.getElementById('add-interaction').addEventListener('click', function() {
            const clienteId = parseInt(document.getElementById('edit-id').value);
            document.getElementById('interaction-cliente-id').value = clienteId;
            document.getElementById('fecha-interaccion').value = new Date().toISOString().slice(0, 16);
            document.getElementById('interaction-modal').classList.remove('hidden');
        });
        
        // Formulario nuevo asesor
        document.getElementById('nuevo-asesor-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const modal = document.getElementById('asesor-modal');
            const editId = modal.dataset.editId;
            
            const asesorData = {
                nombre: document.getElementById('asesor-nombre').value,
                correo: document.getElementById('asesor-correo').value,
                telefono: document.getElementById('asesor-telefono').value,
                fecha_ingreso: document.getElementById('asesor-fechaIngreso').value
            };
            
            let asesorGuardado = null;
            
            if (editId) {
                // Modo edición
                asesorGuardado = await actualizarAsesor(editId, asesorData);
                delete modal.dataset.editId;
            } else {
                // Modo nuevo
                asesorGuardado = await crearAsesor(asesorData);
            }
            
            if (asesorGuardado) {
                mostrarMensaje(editId ? 'Asesor actualizado exitosamente' : 'Asesor creado exitosamente', 'success');
                modal.classList.add('hidden');
                await cargarDatos(); // Recargar datos
                this.reset();
            } else {
                mostrarMensaje('Error al guardar asesor', 'error');
            }
        });
        
        // Cancelar asesor
        document.getElementById('cancel-asesor').addEventListener('click', function() {
            document.getElementById('asesor-modal').classList.add('hidden');
            document.getElementById('nuevo-asesor-form').reset();
            delete document.getElementById('asesor-modal').dataset.editId;
        });
        
        // Cerrar modal asesor
        document.getElementById('close-asesor-modal').addEventListener('click', function() {
            document.getElementById('asesor-modal').classList.add('hidden');
            document.getElementById('nuevo-asesor-form').reset();
            delete document.getElementById('asesor-modal').dataset.editId;
        });
        
      // Botón agregar asesor - CON VERIFICACIÓN DE PERMISOS
document.getElementById('add-asesor').addEventListener('click', function() {
    if (!puedeModificarAsesores()) {
        mostrarMensaje('Solo los administradores pueden crear asesores', 'error');
        return;
    }
    
    document.getElementById('asesor-fechaIngreso').value = new Date().toISOString().split('T')[0];
    document.getElementById('asesor-modal').classList.remove('hidden');
    delete document.getElementById('asesor-modal').dataset.editId;
});
        
        // Actualizar informes al cambiar periodo
        document.getElementById('report-period').addEventListener('change', function() {
            actualizarInformes();
        });
    }
    
    // Validar formulario de cliente
   // Mejorar la validación del formulario
function validarFormularioCliente(form) {
    const celular = form.querySelector('input[name="celular"]').value;
    const correo = form.querySelector('input[name="correo"]').value;
    const asesor = form.querySelector('select[name="asesor"]').value;
    
    // Validaciones existentes
    if (!celular || celular.length < 10) {
        mostrarMensaje('El celular debe tener al menos 10 dígitos', 'error');
        return false;
    }
    
    if (!correo || !correo.includes('@') || !correo.includes('.')) {
        mostrarMensaje('Ingrese un correo electrónico válido', 'error');
        return false;
    }
    
    if (!asesor) {
        mostrarMensaje('Seleccione un asesor de ventas', 'error');
        return false;
    }
    
    // ✅ NUEVA VALIDACIÓN: Documento CFE
    const documentoSubido = document.getElementById('imgbb-url').value;
    if (!documentoSubido) {
        mostrarMensaje('❌ Debes subir el documento de CFE', 'error');
        return false;
    }
    
    return true;
}
    
    // Mostrar mensaje al usuario
    function mostrarMensaje(mensaje, tipo) {
        // Eliminar mensaje anterior si existe
        const mensajeAnterior = document.getElementById('mensaje-flotante');
        if (mensajeAnterior) {
            mensajeAnterior.remove();
        }
        
        const colores = {
            success: 'bg-green-100 border-green-400 text-green-700',
            error: 'bg-red-100 border-red-400 text-red-700',
            warning: 'bg-yellow-100 border-yellow-400 text-yellow-700'
        };
        
        const div = document.createElement('div');
        div.id = 'mensaje-flotante';
        div.className = `fixed top-4 right-4 border px-4 py-3 rounded ${colores[tipo] || colores.success} z-50`;
        div.textContent = mensaje;
        
        document.body.appendChild(div);
        
        // Auto-eliminar después de 3 segundos
        setTimeout(() => {
            div.remove();
        }, 3000);
    }
    
    // Mostrar sección específica
    function mostrarSeccion(sectionId) {
    const sections = [
        'clientes-section', 'nuevo-cliente-section', 'editar-cliente-section', 
        'informe-section', 'reportes-pdf-section', 'asesores-section', 'auditoria-section'
    ];
    sections.forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });
    
    document.getElementById(sectionId).classList.remove('hidden');
    
    // Ocultar menú en móviles
    if (window.innerWidth < 768) {
        document.querySelector('.sidebar').classList.remove('active');
        document.getElementById('sidebar-overlay').classList.remove('active');
    }
}
    
// En el archivo: nuevo - copia.html
// Busca esta función y reemplázala:

// En el archivo: nuevo - copia.html
// Reemplaza la función actualizarListaClientes completa:

// Actualizar lista de clientes
function actualizarListaClientes() {
    const filterStatus = document.getElementById('filter-status').value;
    const searchInput = document.getElementById('search-clientes');
    const searchText = searchInput ? searchInput.value.toLowerCase().trim() : '';
   
    
    console.log('Filtrando clientes...', { 
        filterStatus, 
        searchText, 
        totalClientes: clientes.length 
    });
    
    let filteredClientes = [...clientes]; // Copia de todos los clientes
    
    // 1️⃣ Filtrar por estado (si no es "all")
    if (filterStatus !== 'all') {
        filteredClientes = filteredClientes.filter(c => c.status === filterStatus);
        console.log('Después de filtrar por estado:', filteredClientes.length);
    }
    
    // 2️⃣ Filtrar por texto del buscador (si hay texto)
    if (searchText) {
        filteredClientes = filteredClientes.filter(c => {
            const match = 
                (c.nombre && c.nombre.toLowerCase().includes(searchText)) ||
                (c.empresa && c.empresa.toLowerCase().includes(searchText)) ||
                (c.correo && c.correo.toLowerCase().includes(searchText)) ||
                (c.telefono && c.telefono.includes(searchText)) ||
                (c.celular && c.celular.includes(searchText)) ||
                (c.razon_social && c.razon_social.toLowerCase().includes(searchText));
            
            return match;
        });
        console.log('Después de filtrar por búsqueda:', filteredClientes.length);
    }
    
    const lista = document.getElementById('clientes-list');
    
    if (filteredClientes.length === 0) {
        lista.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                    ${searchText || filterStatus !== 'all' 
                        ? 'No se encontraron clientes que coincidan con los filtros' 
                        : 'No hay clientes registrados'}
                </td>
            </tr>
        `;
        return;
    }
    
    lista.innerHTML = '';
    
    filteredClientes.forEach(cliente => {
        const asesor = asesores.find(a => a.id === cliente.asesor_id) || { nombre: 'No asignado' };
        
        // Formatear fecha de creación
        const fechaCreacion = new Date(cliente.fecha_creacion);
        const ultimaAccionStr = fechaCreacion.toLocaleDateString() + ' ' + fechaCreacion.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        const statusText = {
            'pendiente': 'Pendiente',
            'contactado': 'Contactado',
            'no-contesto': 'No contestó',
            'vendido': 'Vendido'
        };
        
        const statusClass = `status-${cliente.status}`;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="text-sm font-medium text-gray-900">${cliente.nombre}</div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${cliente.celular}</div>
                <div class="text-sm text-gray-500">${cliente.correo}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${asesor.nombre}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${statusText[cliente.status]}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${cliente.fecha_actualizacion ? new Date(cliente.fecha_actualizacion).toLocaleDateString() : ultimaAccionStr}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button onclick="editarCliente(${cliente.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">Editar</button>
                <button onclick="eliminarCliente(${cliente.id})" class="text-red-600 hover:text-red-900">Eliminar</button>
            </td>
        `;
        lista.appendChild(row);
    });
}
    // Editar cliente
 // Editar cliente - CORREGIDO
async function editarCliente(id) {
    try {
        const response = await fetchWithAuth(`${API_BASE_URL}/api/clientes/${id}`);
        
        if (response && response.ok) {
            const data = await response.json();
            const cliente = data.data;
            
            // Campos básicos
            document.getElementById('edit-id').value = cliente.id;
            document.getElementById('edit-nombre').value = cliente.nombre;
            document.getElementById('edit-empresa').value = cliente.empresa || '';
            document.getElementById('edit-telefono').value = cliente.telefono || '';
            document.getElementById('edit-celular').value = cliente.celular;
            document.getElementById('edit-correo').value = cliente.correo;
            document.getElementById('edit-asesor').value = cliente.asesor_id;
            document.getElementById('edit-domicilio').value = cliente.domicilio || '';
            document.getElementById('edit-status').value = cliente.status;
            document.getElementById('edit-link-cfe').value = cliente.link_cfe || '';
            document.getElementById('edit-razonSocial').value = cliente.razon_social || '';
            document.getElementById('edit-descripcionProyecto').value = cliente.descripcion_proyecto || '';
            
            // ✅ TIPO SISTEMA - CARGAR CHECKBOXES
            cargarTipoSistemaCheckboxes(cliente.tipo_sistema);
            
            // Campos adicionales
            document.getElementById('edit-tipoProyecto').value = cliente.tipo_proyecto || '';
            document.getElementById('edit-ubicacion').value = cliente.ubicacion || '';
            document.getElementById('edit-cedis').value = cliente.cedis || '';
            document.getElementById('edit-consumoPromedio').value = cliente.consumo_promedio || '';
            document.getElementById('edit-ahorroEsperado').value = cliente.porcentaje_ahorro || '';
            // Cargar documento (si el cliente tiene imgbb_url o documento_subido)
            try {
                const editImgbbEl = document.getElementById('edit-imgbb-url');
                if (editImgbbEl) editImgbbEl.value = cliente.imgbb_url || cliente.documento_subido || '';
                // Reutilizamos la función existente para mostrar la preview/enlace
                if (typeof cargarDocumentoExistente === 'function') {
                    cargarDocumentoExistente(cliente);
                }
            } catch (e) {
                console.warn('No se pudo cargar la vista previa del documento en el formulario de edición', e);
            }
            
            mostrarSeccion('editar-cliente-section');
            document.getElementById('page-title').textContent = 'Editar Cliente';
            
            // Cargar interacciones del cliente
            await cargarInteraccionesCliente(id);
        }
    } catch (error) {
        console.error('Error al cargar cliente:', error);
        mostrarMensaje('Error al cargar cliente', 'error');
    }
}

// ✅ FUNCIÓN PARA CARGAR CHECKBOXES DE TIPO SISTEMA
function cargarTipoSistemaCheckboxes(valores) {
    if (!valores) {
        // Limpiar todos los checkboxes si no hay valores
        document.querySelectorAll('#editar-cliente-section input[name="tipoSistema"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        return;
    }
    
    // Limpiar checkboxes primero
    document.querySelectorAll('#editar-cliente-section input[name="tipoSistema"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Marcar los checkboxes correspondientes
    const valoresArray = valores.split(',').map(v => v.trim());
    
    valoresArray.forEach(valor => {
        const checkbox = document.querySelector(`#editar-cliente-section input[name="tipoSistema"][value="${valor}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
}

// Y en editarCliente, después de cargar los otros campos:
cargarTipoSistemaCheckboxes(cliente.tipo_sistema);
    // Eliminar cliente
    async function eliminarCliente(id) {
        if (confirm('¿Estás seguro de que deseas eliminar este cliente?')) {
            const success = await eliminarClienteAPI(id);
            
            if (success) {
                mostrarMensaje('Cliente eliminado exitosamente', 'success');
                await cargarDatos(); // Recargar datos
            } else {
                mostrarMensaje('Error al eliminar cliente', 'error');
            }
        }
    }
    
    // Actualizar opciones de asesores en formularios
    function actualizarOpcionesAsesores() {
        const selectNew = document.getElementById('asesor_id');
        const selectEdit = document.getElementById('edit-asesor');
        
        // Clear existing options for both selects
        selectNew.innerHTML = '<option value="">Seleccionar asesor</option>';
        selectEdit.innerHTML = '<option value="">Seleccionar asesor</option>';
        
        asesores.forEach(asesor => {
            const option1 = document.createElement('option');
            option1.value = asesor.id;
            option1.textContent = asesor.nombre;
            selectNew.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = asesor.id;
            option2.textContent = asesor.nombre;
            selectEdit.appendChild(option2);
        });
    }
    
    // Cargar interacciones de un cliente
    async function cargarInteraccionesCliente(clienteId) {
        const lista = document.getElementById('interacciones-list');
        lista.innerHTML = '';
        
        const clienteInteracciones = await obtenerInteraccionesCliente(clienteId);
        
        if (clienteInteracciones.length === 0) {
            lista.innerHTML = '<p class="text-gray-500 text-center py-4">No hay interacciones registradas</p>';
            return;
        }
        
        const tipoIconos = {
            'llamada': 'phone',
            'correo': 'envelope',
            'reunion': 'calendar-alt',
            'cotizacion': 'file-invoice-dollar'
        };
        
        const tipoClases = {
            'llamada': 'bg-blue-100 text-blue-600',
            'correo': 'bg-purple-100 text-purple-600',
            'reunion': 'bg-yellow-100 text-yellow-600',
            'cotizacion': 'pink-100 text-pink-600'
        };
        
        const resultadoTextos = {
            'pendiente': 'Pendiente',
            'contactado': 'Contactado',
            'no-contesto': 'No contestó',
            'vendido': 'Vendido',
            'cotizacion-enviada': 'Cotización enviada'
        };
        
        clienteInteracciones.forEach(interaccion => {
            const fecha = new Date(interaccion.fecha);
            const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const div = document.createElement('div');
            div.className = 'bg-gray-50 rounded-lg p-4';
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full ${tipoClases[interaccion.tipo]} flex items-center justify-center mr-3">
                            <i class="fas fa-${tipoIconos[interaccion.tipo]}"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 capitalize">${interaccion.tipo}</h4>
                            <p class="text-xs text-gray-500">${fechaFormateada}</p>
                        </div>
                    </div>
                    ${interaccion.resultado ? 
                        `<span class="px-2 py-1 text-xs rounded-full ${interaccion.resultado === 'pendiente' ? 'bg-yellow-100 text-yellow-800' : 
                          interaccion.resultado === 'contactado' ? 'bg-green-100 text-green-800' : 
                          interaccion.resultado === 'no-contesto' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                            ${resultadoTextos[interaccion.resultado]}
                        </span>` : 
                        ''}
                </div>
                <div class="mt-3 text-sm text-gray-600">
                    ${interaccion.notas}
                </div>
            `;
            lista.appendChild(div);
        });
        
    }
    
    function actualizarListaAsesores() {
    const lista = document.getElementById('asesores-list');

    // Verificar permisos antes de mostrar
    if (!puedeVerAsesores()) {
        lista.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-lock text-2xl mb-2 block"></i>
                    No tienes permisos para ver la lista de asesores
                </td>
            </tr>
        `;
        return;
    }

    // Si no hay asesores cargados
    if (!asesores || asesores.length === 0) {
        lista.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    No hay asesores registrados.
                </td>
            </tr>
        `;
        return;
    }

    // Limpiar tabla y generar filas
    lista.innerHTML = '';
    asesores.forEach(asesor => {
        const numClientes = clientes.filter(c => c.asesor_id === asesor.id).length;
        const numVentas = clientes.filter(c => c.asesor_id === asesor.id && c.status === 'vendido').length;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="text-sm font-medium text-gray-900">${asesor.nombre}</div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${asesor.correo}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${asesor.telefono}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${numClientes}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${numVentas}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button onclick="editarAsesor(${asesor.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">Editar</button>
                <button onclick="eliminarAsesor(${asesor.id})" class="text-red-600 hover:text-red-900">Eliminar</button>
            </td>
        `;
        lista.appendChild(row);
    });
}

// Editar asesor - CON VERIFICACIÓN DE PERMISOS
async function editarAsesor(id) {
    if (!puedeModificarAsesores()) {
        mostrarMensaje('Solo los administradores pueden editar asesores', 'error');
        return;
    }
    
    // Resto del código existente...
}
    
    // Eliminar asesor
    async function eliminarAsesor(id) {
        // Verificar si el asesor tiene clientes asignados
        const tieneClientes = clientes.some(c => c.asesor_id === id);
        
        if (tieneClientes) {
            mostrarMensaje('No se puede eliminar el asesor porque tiene clientes asignados. Reasigna los clientes primero.', 'error');
            return;
        }
        
        if (confirm('¿Estás seguro de que deseas eliminar este asesor?')) {
            const success = await eliminarAsesorAPI(id);
            
            if (success) {
                mostrarMensaje('Asesor eliminado exitosamente', 'success');
                await cargarDatos(); // Recargar datos
            } else {
                mostrarMensaje('Error al eliminar asesor', 'error');
            }
        }
    }
    
    // Editar asesor
    async function editarAsesor(id) {
        const asesor = asesores.find(a => a.id === id);
        if (!asesor) return;
        
        document.getElementById('asesor-nombre').value = asesor.nombre;
        document.getElementById('asesor-correo').value = asesor.correo;
        document.getElementById('asesor-telefono').value = asesor.telefono;
        document.getElementById('asesor-fechaIngreso').value = asesor.fecha_ingreso;
        document.getElementById('asesor-modal').dataset.editId = id;
        document.getElementById('asesor-modal').classList.remove('hidden');
    }
    
// En el archivo: nuevo - copia.html
// Busca la función actualizarInformes y reemplázala:

// Función corregida para actualizar informes
function actualizarInformes() {
    if (!clientes || clientes.length === 0) {
        console.warn('No hay datos de clientes para generar informes');
        document.getElementById('total-clientes').textContent = '0';
        document.getElementById('nuevos-clientes').textContent = '0';
        document.getElementById('tasa-conversion').textContent = '0%';
        return;
    }

    // Contar clientes por estado
    const counts = { pendiente: 0, contactado: 0, 'no-contesto': 0, vendido: 0 };
    clientes.forEach(c => {
        if (counts[c.status] !== undefined) counts[c.status]++;
    });

    // KPIs CORREGIDOS
    document.getElementById('total-clientes').textContent = clientes.length;
    
    // Clientes nuevos: clientes creados en los últimos 7 días
    const unaSemanaAtras = new Date();
    unaSemanaAtras.setDate(unaSemanaAtras.getDate() - 7);
    
    const clientesNuevos = clientes.filter(c => {
        const fechaCreacion = new Date(c.fecha_creacion);
        return fechaCreacion >= unaSemanaAtras;
    }).length;
    
    document.getElementById('nuevos-clientes').textContent = clientesNuevos;
    
    // Tasa de conversión: clientes vendidos vs total
    document.getElementById('tasa-conversion').textContent = 
        clientes.length > 0 ? ((counts.vendido / clientes.length) * 100).toFixed(1) + "%" : "0%";

    console.log('Estadísticas:', {
        total: clientes.length,
        nuevos: clientesNuevos,
        vendidos: counts.vendido,
        tasaConversion: ((counts.vendido / clientes.length) * 100).toFixed(1) + '%'
    });

    // Destruir gráficos existentes si los hay
    if (window.statusChart) window.statusChart.destroy();
    if (window.asesorChart) window.asesorChart.destroy();

    // Gráfico por status
    const ctx1 = document.getElementById('status-chart');
    if (ctx1) {
        window.statusChart = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Pendiente', 'Contactado', 'No contestó', 'Vendido'],
                datasets: [{
                    data: Object.values(counts),
                    backgroundColor: ['#ff951c', '#6812b9', '#dc2626', '#21f047']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Gráfico por asesor
    const asesoresCount = {};
    clientes.forEach(c => {
        const asesorId = c.asesor_id;
        let asesorNombre = 'Sin asignar';
        
        if (asesorId) {
            const asesor = asesores.find(a => a.id === asesorId);
            asesorNombre = asesor ? asesor.nombre : `Asesor ${asesorId}`;
        }
        
        asesoresCount[asesorNombre] = (asesoresCount[asesorNombre] || 0) + 1;
    });

    const ctx2 = document.getElementById('asesor-chart');
    if (ctx2) {
        window.asesorChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: Object.keys(asesoresCount),
                datasets: [{
                    label: 'Número de Clientes',
                    data: Object.values(asesoresCount),
                    backgroundColor: '#3b82f6'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
    
    // Actualizar tabla de interacciones recientes
    actualizarTablaInteraccionesRecientes();
}  
    // Después del login, verificar permisos y ocultar secciones
function verificarPermisosUsuario(usuario) {
  if (usuario.role === 'restricted') {
    // Ocultar sección de asesores
    const seccionAsesores = document.getElementById('seccion-asesores');
    const menuAsesores = document.getElementById('menu-asesores');
    
    if (seccionAsesores) seccionAsesores.style.display = 'none';
    if (menuAsesores) menuAsesores.style.display = 'none';
    
    // También puedes deshabilitar botones de agregar/editar en otras secciones
    const botonesPrivilegiados = document.querySelectorAll('.btn-admin');
    botonesPrivilegiados.forEach(boton => {
      boton.style.display = 'none';
    });
  }
}
    // ========================================
    // FUNCIONES GLOBALES
    // ========================================
    
    window.editarCliente = editarCliente;
    window.eliminarCliente = eliminarCliente;
    window.editarAsesor = editarAsesor;
    window.eliminarAsesor = eliminarAsesor;
    
    // ========================================
    // LOGIN
    // ========================================
    
    document.addEventListener('DOMContentLoaded', function () {
        const loginScreen = document.getElementById('login-screen');
        const mainPanel = document.getElementById('main-panel');
        const loginForm = document.getElementById('login-form');
        
        loginForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    loginScreen.classList.add("hidden");
                    mainPanel.classList.remove("hidden");
                    
                    // Cargar datos iniciales
                    await cargarDatos();
                } else {
                    alert("Usuario o contraseña incorrectos.");
                }
            } catch (error) {
                console.error('Error en el login:', error);
                alert("Error de conexión. Intenta nuevamente.");
            }
        });
    });
    
    // Cerrar sesión
    function cerrarSesion() {
    fetch('http://localhost:3000/api/rfid/reset', { method: 'POST' });

    localStorage.removeItem('usuario_logeado');
    window.location.href = 'login.html';
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        document.getElementById('main-panel').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
    }
    console.log('🚪 Cerrando sesión y limpiando RFID...');
    
    // 1. Limpiar localStorage COMPLETAMENTE
    localStorage.removeItem('usuario_logeado');
    localStorage.removeItem('crm_token');
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    
    // 2. Llamar al endpoint de reset RFID
    fetch('http://localhost:3000/api/rfid/reset', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    }).catch(err => console.log('Error limpiando RFID:', err));
    
    // 3. Redirigir inmediatamente
    setTimeout(() => {
        window.location.href = 'login.html';
    }, 500);

</script>
<script>
    
document.addEventListener('DOMContentLoaded', () => {
  const formAsesor = document.getElementById('nuevo-asesor-form');
  if (formAsesor) {
    formAsesor.addEventListener('submit', async (e) => {
      e.preventDefault();

      const token = localStorage.getItem('crm_token');
      if (!token) {
        alert("Sesión expirada. Inicia sesión de nuevo.");
        window.location.href = "login.html";
        return;
      }

      const data = {
        nombre: document.getElementById('asesor-nombre').value,
        correo: document.getElementById('asesor-correo').value,
        telefono: document.getElementById('asesor-telefono').value,
         fecha_ingreso: document.getElementById('asesor-fechaIngreso').value// 👈 corregido
      };

      try {
        const resp = await fetch('http://localhost:3000/api/asesores', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await resp.json();
        if (result.success) {
          alert("Asesor agregado correctamente.");
          formAsesor.reset();
          document.getElementById('asesor-modal').classList.add('hidden'); // cerrar modal
          // refrescar lista de asesores
          await cargarAsesores();
          actualizarListaAsesores();
        } else {
          alert("Error: " + result.message);
        }
      } catch (err) {
        console.error("Error al guardar asesor:", err);
        alert("No se pudo guardar el asesor.");
      }
    });
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Configurar la navegación
document.getElementById('nav-reportes-pdf').addEventListener('click', function(e) {
    e.preventDefault();
    mostrarSeccion('reportes-pdf-section');
    document.getElementById('page-title').textContent = 'Reportes PDF';
    inicializarReportesPDF();
});

// Inicializar la sección de reportes PDF
function inicializarReportesPDF() {
    cargarOpcionesAsesoresReporte();
    configurarFechaPersonalizada();
    configurarVistaPrevia();
}

// Cargar asesores en el filtro
function cargarOpcionesAsesoresReporte() {
    const select = document.getElementById('filtro-asesor');
    if (!select) return;
    
    select.innerHTML = '<option value="todos">Todos los asesores</option>';
    
    if (asesores && asesores.length > 0) {
        asesores.forEach(asesor => {
            const option = document.createElement('option');
            option.value = asesor.id;
            option.textContent = asesor.nombre;
            select.appendChild(option);
        });
    }
}

// Configurar fecha personalizada
function configurarFechaPersonalizada() {
    const periodoSelect = document.getElementById('reporte-periodo');
    const fechasDiv = document.getElementById('fechas-personalizadas');
    
    if (!periodoSelect || !fechasDiv) return;
    
    periodoSelect.addEventListener('change', function() {
        if (this.value === 'personalizado') {
            fechasDiv.classList.remove('hidden');
            
            // Establecer fechas por defecto
            const hoy = new Date();
            const haceUnMes = new Date();
            haceUnMes.setMonth(hoy.getMonth() - 1);
            
            document.getElementById('fecha-inicio').value = haceUnMes.toISOString().split('T')[0];
            document.getElementById('fecha-fin').value = hoy.toISOString().split('T')[0];
        } else {
            fechasDiv.classList.add('hidden');
        }
    });
}

// Configurar vista previa
fu// Configurar vista previa de forma segura
function configurarVistaPrevia() {
    const btnVistaPrevia = document.getElementById('actualizar-vista-previa');
    const btnGenerarPDF = document.getElementById('generar-pdf');
    
    if (btnVistaPrevia) {
        btnVistaPrevia.addEventListener('click', function() {
            generarVistaPrevia();
        });
    }
    
    if (btnGenerarPDF) {
        btnGenerarPDF.addEventListener('click', async function() {
            try {
                await generarPDF();
            } catch (error) {
                console.error('Error al generar PDF:', error);
                mostrarMensaje('Error: ' + error.message, 'error');
            }
        });
    }
}

// Hacer lo mismo para auditoría
function configurarVistaPreviaAuditoria() {
    const btnVistaPrevia = document.getElementById('actualizar-auditoria');
    const btnGenerarPDF = document.getElementById('generar-pdf-auditoria');
    
    if (btnVistaPrevia) {
        btnVistaPrevia.addEventListener('click', function() {
            generarVistaPreviaAuditoria();
        });
    }
    
    if (btnGenerarPDF) {
        btnGenerarPDF.addEventListener('click', async function() {
            try {
                await generarPDFAuditoria();
            } catch (error) {
                console.error('Error al generar PDF de auditoría:', error);
                mostrarMensaje('Error: ' + error.message, 'error');
            }
        });
    }
}

// Obtener filtros del reporte
// REEMPLAZA la función obtenerFiltrosReporte completa:
function obtenerFiltrosReporte() {
    const periodo = document.getElementById('reporte-periodo').value;
    let fechaInicio, fechaFin;
    
    if (periodo === 'personalizado') {
        fechaInicio = document.getElementById('fecha-inicio').value;
        fechaFin = document.getElementById('fecha-fin').value;
    } else {
        const fechas = calcularFechasPorPeriodo(periodo);
        fechaInicio = fechas.inicio;
        fechaFin = fechas.fin;
    }
    
    // Obtener y validar asesor_id
    const asesorSelect = document.getElementById('filtro-asesor');
    let asesor_id = 'todos';
    if (asesorSelect && asesorSelect.value !== 'todos') {
        asesor_id = parseInt(asesorSelect.value) || 'todos';
    }
    
    return {
        periodo,
        fechaInicio: fechaInicio || new Date().toISOString().split('T')[0],
        fechaFin: fechaFin || new Date().toISOString().split('T')[0],
        estado: document.getElementById('filtro-estado').value,
        asesor_id: asesor_id,
        orden: document.getElementById('orden-reporte').value
    };
}

// Calcular fechas por período
function calcularFechasPorPeriodo(periodo) {
    const hoy = new Date();
    let inicio = new Date();
    let fin = new Date(hoy); // Usar hoy como fecha fin
    
    switch(periodo) {
        case 'semana':
            inicio.setDate(hoy.getDate() - 7);
            break;
        case 'mes':
            inicio.setMonth(hoy.getMonth() - 1);
            break;
        case 'trimestre':
            inicio.setMonth(hoy.getMonth() - 3);
            break;
        case 'ano':
            inicio.setFullYear(hoy.getFullYear() - 1);
            break;
        default:
            inicio.setMonth(hoy.getMonth() - 1);
    }
    
    return {
        inicio: inicio.toISOString().split('T')[0],
        fin: fin.toISOString().split('T')[0]
    };
}

// Función MEJORADA para obtener datos del reporte
// Función CORREGIDA para obtener datos del reporte
async function obtenerDatosReporte(filtros) {
    const token = localStorage.getItem('crm_token');
    
    if (!token) {
        throw new Error('No hay token de autenticación');
    }
    
    console.log('🔍 Obteniendo datos del reporte con filtros:', filtros);
    
    // Construir URL con parámetros CORREGIDOS
    const params = new URLSearchParams();
    
    // Agregar parámetros básicos
    params.append('fechaInicio', filtros.fechaInicio);
    params.append('fechaFin', filtros.fechaFin);
    
    // Agregar parámetros opcionales solo si no son "todos"
    if (filtros.estado && filtros.estado !== 'todos') {
        params.append('estado', filtros.estado);
    }
    
    if (filtros.asesor_id && filtros.asesor_id !== 'todos') {
        params.append('asesor_id', filtros.asesor_id);
    }
    
    if (filtros.orden) {
        params.append('orden', filtros.orden);
    }
    
    const url = `${API_BASE_URL}/api/reportes/clientes?${params}`;
    
    console.log('📤 URL de petición:', url);
    
    try {
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        console.log('📥 Respuesta del servidor - Status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ Error HTTP:', response.status, errorText);
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('✅ Datos recibidos correctamente:', data.data ? data.data.length : 0, 'registros');
        
        if (!data.success) {
            throw new Error(data.message || 'Error en la respuesta del servidor');
        }
        
        return data.data || [];
        
    } catch (error) {
        console.error('💥 Error en obtenerDatosReporte:', error);
        mostrarMensaje(`Error al obtener datos: ${error.message}`, 'error');
        throw error;
    }
}

// Función auxiliar para formatear fechas
function formatearFecha(fechaString) {
    if (!fechaString) return 'N/A';
    const fecha = new Date(fechaString);
    return fecha.toLocaleDateString('es-MX', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

// Generar vista previa del reporte
async function generarVistaPrevia() {
    const vistaPrevia = document.getElementById('vista-previa-reporte');
    if (!vistaPrevia) {
        console.error('❌ No se encontró el elemento vista-previa-reporte');
        return;
    }
    
    vistaPrevia.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-indigo-600 text-xl mb-2"></i><p class="text-gray-600">Generando vista previa...</p></div>';
    
    try {
        const filtros = obtenerFiltrosReporte();
        console.log('🎯 Generando vista previa con filtros:', filtros);
        
        const datosReporte = await obtenerDatosReporte(filtros);
        
        mostrarVistaPrevia(datosReporte, filtros);
        
    } catch (error) {
        console.error('❌ Error generando vista previa:', error);
        vistaPrevia.innerHTML = `
            <div class="text-center py-4 text-red-600">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Error al generar vista previa: ${error.message}
            </div>
        `;
    }
}

// Mostrar vista previa
function mostrarVistaPrevia(datos, filtros) {
    const vistaPrevia = document.getElementById('vista-previa-reporte');
    if (!vistaPrevia) return;
    
    if (!datos || datos.length === 0) {
        vistaPrevia.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i>
                <p class="text-gray-500">No hay datos para el período seleccionado</p>
                <p class="text-gray-400 text-sm mt-2">Período: ${filtros.fechaInicio} al ${filtros.fechaFin}</p>
            </div>
        `;
        return;
    }
    
    // Calcular todas las estadísticas
    const pendientes = datos.filter(c => c.status === 'pendiente').length;
    const contactados = datos.filter(c => c.status === 'contactado').length;
    const noContesto = datos.filter(c => c.status === 'no-contesto').length;
    const vendidos = datos.filter(c => c.status === 'vendido').length;
    const tasaConversion = datos.length > 0 ? ((vendidos / datos.length) * 100).toFixed(1) : 0;
    
    let html = `
        <div class="bg-white rounded-lg p-4 mb-4 border">
            <h4 class="font-semibold text-lg mb-3 text-gray-800">Resumen del Reporte</h4>
            <div class="grid grid-cols-2 md:grid-cols-6 gap-3 text-sm">
                <div class="text-center p-3 bg-blue-50 rounded-lg border">
                    <div class="font-bold text-blue-600 text-lg">${datos.length}</div>
                    <div class="text-blue-800 text-xs font-medium">Total</div>
                </div>
                <div class="text-center p-3 bg-amber-50 rounded-lg border">
                    <div class="font-bold text-amber-600 text-lg">${pendientes}</div>
                    <div class="text-amber-800 text-xs font-medium">Pendientes</div>
                </div>
                <div class="text-center p-3 bg-blue-50 rounded-lg border">
                    <div class="font-bold text-blue-600 text-lg">${contactados}</div>
                    <div class="text-blue-800 text-xs font-medium">Contactados</div>
                </div>
                <div class="text-center p-3 bg-red-50 rounded-lg border">
                    <div class="font-bold text-red-600 text-lg">${noContesto}</div>
                    <div class="text-red-800 text-xs font-medium">No contestó</div>
                </div>
                <div class="text-center p-3 bg-green-50 rounded-lg border">
                    <div class="font-bold text-green-600 text-lg">${vendidos}</div>
                    <div class="text-green-800 text-xs font-medium">Vendidos</div>
                </div>
                <div class="text-center p-3 bg-purple-50 rounded-lg border">
                    <div class="font-bold text-purple-600 text-lg">${tasaConversion}%</div>
                    <div class="text-purple-800 text-xs font-medium">Conversión</div>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto border rounded-lg">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 border text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                        <th class="px-4 py-3 border text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empresa</th>
                        <th class="px-4 py-3 border text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacto</th>
                        <th class="px-4 py-3 border text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asesor</th>
                        <th class="px-4 py-3 border text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                        <th class="px-4 py-3 border text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Interac.</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
    `;
    
    datos.forEach(cliente => {
        const asesor = asesores.find(a => a.id === cliente.asesor_id) || { nombre: 'No asignado' };
        const statusClass = {
            'pendiente': 'bg-amber-100 text-amber-800',
            'contactado': 'bg-blue-100 text-blue-800',
            'no-contesto': 'bg-red-100 text-red-800',
            'vendido': 'bg-green-100 text-green-800'
        }[cliente.status] || 'bg-gray-100 text-gray-800';
        
        const estadoTexto = {
            'pendiente': 'Pendiente',
            'contactado': 'Contactado',
            'no-contesto': 'No contestó',
            'vendido': 'Vendido'
        }[cliente.status] || cliente.status;
        
        html += `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3 border text-sm">
                    <div class="font-medium text-gray-900">${cliente.nombre || 'N/A'}</div>
                </td>
                <td class="px-4 py-3 border text-sm">
                    <div class="text-gray-600">${cliente.empresa || 'N/A'}</div>
                </td>
                <td class="px-4 py-3 border text-sm">
                    <div class="font-medium">${cliente.celular || 'N/A'}</div>
                    <div class="text-gray-500 text-xs">${cliente.correo || 'Sin correo'}</div>
                </td>
                <td class="px-4 py-3 border text-sm text-gray-700">${asesor.nombre}</td>
                <td class="px-4 py-3 border text-sm">
                    <span class="px-2 py-1 text-xs rounded-full font-medium ${statusClass}">${estadoTexto}</span>
                </td>
                <td class="px-4 py-3 border text-sm text-center font-medium">${cliente.total_interacciones || 0}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-600"><strong>Período:</strong> ${filtros.fechaInicio} al ${filtros.fechaFin}</p>
            <p class="text-sm text-gray-600"><strong>Total de clientes:</strong> ${datos.length} | <strong>Tasa de conversión:</strong> ${tasaConversion}%</p>
            <p class="text-xs text-gray-500 mt-1">Vista previa generada el ${new Date().toLocaleString()}</p>
        </div>
    `;
    
    vistaPrevia.innerHTML = html;
}

// Función PRINCIPAL para generar PDF - CON LOGO EN BASE64
// Función PRINCIPAL para generar PDF - COMPLETA Y CORREGIDA
async function generarPDF() {
    try {
        console.log('🔄 Iniciando generación de PDF...');
        
        // Verificar librerías
        if (typeof window.jspdf === 'undefined') {
            throw new Error('La librería jsPDF no está cargada. Recarga la página.');
        }
        
        mostrarMensaje('Generando PDF...', 'info');
        
        const filtros = obtenerFiltrosReporte();
        const datosReporte = await obtenerDatosReporte(filtros);
        
        if (!datosReporte || datosReporte.length === 0) {
            mostrarMensaje('No hay datos para generar el PDF', 'warning');
            return;
        }
        
        console.log('📊 Generando PDF con', datosReporte.length, 'registros');
        
        // Crear el PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Configuración del documento
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 14;

        // ==============================================
        // 🌟 LOGO SOLAREVER EN BASE64
        // ==============================================
        const LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAABkCAYAAADTf2piAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAgSURBVHgB7cEBDQAAAMIg+6d+FLjAAAAAAAAAAAAAAAAAAAAA4A8zOAAF3gAAAABJRU5ErkJggg==';
        
        // AGREGAR LOGO Y TEXTO
        try {
            // Agregar logo
            doc.addImage(LOGO_BASE64, 'PNG', margin, 10, 40, 15);
            
            // Texto del logo
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('SOLAREVER', margin + 45, 18);
            
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('Quality is our life', margin + 45, 23);
        } catch (error) {
            console.warn('No se pudo cargar el logo, usando texto alternativo');
            // Fallback si el logo no carga
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('SOLAREVER', margin, 15);
            doc.setFontSize(10);
            doc.text('Quality is our life', margin, 22);
        }

        // Título del reporte
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.text('REPORTE DE CLIENTES', pageWidth / 2, 40, { align: 'center' });
        
        // Información del reporte
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Período: ${formatearFecha(filtros.fechaInicio)} - ${formatearFecha(filtros.fechaFin)}`, margin, 55);
        doc.text(`Generado: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margin, 62);
        doc.text(`Total de clientes: ${datosReporte.length}`, margin, 69);
        
        // Estadísticas
        const pendientes = datosReporte.filter(c => c.status === 'pendiente').length;
        const contactados = datosReporte.filter(c => c.status === 'contactado').length;
        const noContesto = datosReporte.filter(c => c.status === 'no-contesto').length;
        const vendidos = datosReporte.filter(c => c.status === 'vendido').length;
        const tasaConversion = datosReporte.length > 0 ? ((vendidos / datosReporte.length) * 100).toFixed(1) : 0;
        
        // Estadísticas a la derecha
        doc.text(`Pendientes: ${pendientes}`, pageWidth - margin, 55, { align: 'right' });
        doc.text(`Contactados: ${contactados}`, pageWidth - margin, 62, { align: 'right' });
        doc.text(`No contestó: ${noContesto}`, pageWidth - margin, 69, { align: 'right' });
        doc.text(`Vendidos: ${vendidos}`, pageWidth - margin, 76, { align: 'right' });
        doc.text(`Tasa conversión: ${tasaConversion}%`, pageWidth - margin, 83, { align: 'right' });
        
        // Preparar datos para la tabla
        const tableData = datosReporte.map(cliente => {
            const asesor = asesores.find(a => a.id === cliente.asesor_id) || { nombre: 'No asignado' };
            
            const estadoTexto = {
                'pendiente': 'PENDIENTE',
                'contactado': 'CONTACTADO', 
                'no-contesto': 'NO CONTESTÓ',
                'vendido': 'VENDIDO'
            }[cliente.status] || cliente.status.toUpperCase();
            
            const fechaCreacion = new Date(cliente.fecha_creacion);
            const fechaFormateada = fechaCreacion.toLocaleDateString('es-MX');
            
            return [
                cliente.nombre || 'N/A',
                cliente.empresa || 'N/A',
                cliente.celular || 'N/A',
                cliente.correo || 'N/A',
                asesor.nombre,
                estadoTexto,
                cliente.total_interacciones || 0,
                fechaFormateada
            ];
            
        });
        
        // Crear tabla (ajustar startY porque el encabezado es más grande)
        doc.autoTable({
            startY: 90,  // Ajustado de 80 a 90
            head: [
                ['Cliente', 'Empresa', 'Celular', 'Correo', 'Asesor', 'Estado', 'Interac.', 'Fecha Creación']
            ],
            body: tableData,
            theme: 'grid',
            headStyles: {
                fillColor: [79, 70, 229],
                textColor: 255,
                fontStyle: 'bold',
                fontSize: 8
            },
            alternateRowStyles: {
                fillColor: [248, 250, 252]
            },
            styles: {
                fontSize: 7,
                cellPadding: 2,
                lineColor: [200, 200, 200],
                lineWidth: 0.1
            },
            columnStyles: {
                0: { cellWidth: 25, fontStyle: 'bold' },
                1: { cellWidth: 22 },
                2: { cellWidth: 18 },
                3: { cellWidth: 28 },
                4: { cellWidth: 20 },
                5: { cellWidth: 15 },
                6: { cellWidth: 10 },
                7: { cellWidth: 15 }
            }
        });
        
        // Pie de página
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(128);
            doc.text(
                `Página ${i} de ${pageCount} - SOLAREVER CRM - ${new Date().toLocaleDateString()}`,
                pageWidth / 2,
                doc.internal.pageSize.getHeight() - 10,
                { align: 'center' }
            );
        }
        
        // Descargar el PDF
        const nombreArchivo = `Reporte_SOLAREVER_${filtros.fechaInicio}_a_${filtros.fechaFin}.pdf`;
        doc.save(nombreArchivo);
        
        console.log('✅ PDF generado exitosamente:', nombreArchivo);
        mostrarMensaje('PDF generado exitosamente', 'success');
        
    } catch (error) {
        console.error('❌ Error generando PDF:', error);
        mostrarMensaje('Error al generar PDF: ' + error.message, 'error');
    }
}
// ========================================
// FUNCIONES DE AUDITORÍA
// ========================================

// Configurar navegación a auditoría - SOLO ADMIN
document.getElementById('nav-auditoria').addEventListener('click', function(e) {
    e.preventDefault();
    
    const { usuario } = obtenerUsuarioLogueado();
    
    if (!usuario || usuario.role !== 'admin') {
        mostrarMensaje('No tienes permisos para acceder a la sección de auditoría. Solo administradores.', 'error');
        return;
    }
    
    mostrarSeccion('auditoria-section');
    document.getElementById('page-title').textContent = 'Auditoría de Cambios';
    inicializarAuditoria();
});

// Inicializar la sección de auditoría
function inicializarAuditoria() {
    cargarOpcionesFiltrosAuditoria();
    configurarFechasAuditoria();
    configurarVistaPreviaAuditoria();
}

// Cargar opciones de filtros
async function cargarOpcionesFiltrosAuditoria() {
    await cargarOpcionesUsuariosAuditoria();
    await cargarOpcionesClientesAuditoria();
}

// Cargar usuarios en el filtro
async function cargarOpcionesUsuariosAuditoria() {
    const select = document.getElementById('filtro-usuario');
    if (!select) return;
    
    select.innerHTML = '<option value="todos">Todos los usuarios</option>';
    
    try {
        const response = await fetchWithAuth(`${API_BASE_URL}/api/usuarios`);
        if (response && response.ok) {
            const data = await response.json();
            if (data.success && data.data) {
                data.data.forEach(usuario => {
                    const option = document.createElement('option');
                    option.value = usuario.id;
                    option.textContent = usuario.username;
                    select.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error al cargar usuarios para auditoría:', error);
    }
}

// Cargar clientes en el filtro
async function cargarOpcionesClientesAuditoria() {
    const select = document.getElementById('filtro-cliente');
    if (!select) return;
    
    select.innerHTML = '<option value="todos">Todos los clientes</option>';
    
    try {
        const response = await fetchWithAuth(`${API_BASE_URL}/api/clientes`);
        if (response && response.ok) {
            const data = await response.json();
            if (data.success && data.data) {
                data.data.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nombre;
                    select.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error al cargar clientes para auditoría:', error);
    }
}

// Configurar fechas personalizadas
function configurarFechasAuditoria() {
    const periodoSelect = document.getElementById('auditoria-periodo');
    const fechasDiv = document.getElementById('auditoria-fechas-personalizadas');
    
    if (!periodoSelect || !fechasDiv) return;
    
    periodoSelect.addEventListener('change', function() {
        if (this.value === 'personalizado') {
            fechasDiv.classList.remove('hidden');
            
            // Establecer fechas por defecto
            const hoy = new Date();
            const haceUnaSemana = new Date();
            haceUnaSemana.setDate(hoy.getDate() - 7);
            
            document.getElementById('auditoria-fecha-inicio').value = haceUnaSemana.toISOString().split('T')[0];
            document.getElementById('auditoria-fecha-fin').value = hoy.toISOString().split('T')[0];
        } else {
            fechasDiv.classList.add('hidden');
        }
    });
}

// Configurar vista previa
function configurarVistaPreviaAuditoria() {
    const btnVistaPrevia = document.getElementById('actualizar-auditoria');
    const btnGenerarPDF = document.getElementById('generar-pdf-auditoria');
    
    if (btnVistaPrevia) {
        btnVistaPrevia.addEventListener('click', function() {
            generarVistaPreviaAuditoria();
        });
    }
    
    if (btnGenerarPDF) {
        btnGenerarPDF.addEventListener('click', function() {
            generarPDFAuditoria();
        });
    }
}

// Obtener filtros de auditoría
function obtenerFiltrosAuditoria() {
    const periodo = document.getElementById('auditoria-periodo').value;
    let fechaInicio, fechaFin;
    
    if (periodo === 'personalizado') {
        fechaInicio = document.getElementById('auditoria-fecha-inicio').value;
        fechaFin = document.getElementById('auditoria-fecha-fin').value;
    } else {
        const fechas = calcularFechasAuditoria(periodo);
        fechaInicio = fechas.inicio;
        fechaFin = fechas.fin;
    }
    
    return {
        periodo,
        fechaInicio: fechaInicio || new Date().toISOString().split('T')[0],
        fechaFin: fechaFin || new Date().toISOString().split('T')[0],
        accion: document.getElementById('filtro-accion').value,
        usuario: document.getElementById('filtro-usuario').value,
        cliente: document.getElementById('filtro-cliente').value,
        orden: document.getElementById('orden-auditoria').value
    };
}

// Calcular fechas por período para auditoría
function calcularFechasAuditoria(periodo) {
    const hoy = new Date();
    let inicio = new Date();
    let fin = new Date(hoy);
    
    switch(periodo) {
        case 'hoy':
            inicio = new Date(hoy);
            break;
        case 'semana':
            inicio.setDate(hoy.getDate() - 7);
            break;
        case 'mes':
            inicio.setMonth(hoy.getMonth() - 1);
            break;
        case 'trimestre':
            inicio.setMonth(hoy.getMonth() - 3);
            break;
        case 'ano':
            inicio.setFullYear(hoy.getFullYear() - 1);
            break;
        default:
            inicio.setDate(hoy.getDate() - 7);
    }
    
    return {
        inicio: inicio.toISOString().split('T')[0],
        fin: fin.toISOString().split('T')[0] + ' 23:59:59'
    };
}

// Obtener datos de auditoría del backend - CON VERIFICACIÓN DE PERMISOS
async function obtenerDatosAuditoria(filtros) {
    const token = localStorage.getItem('crm_token');
    const { usuario } = obtenerUsuarioLogueado();
    
    if (!token) {
        throw new Error('No hay token de autenticación');
    }
    
    // Verificar permisos en el frontend también
    if (!usuario || usuario.role !== 'admin') {
        throw new Error('No tienes permisos para acceder a la auditoría');
    }
    
    console.log('🔍 Obteniendo datos de auditoría con filtros:', filtros);
    
    // Resto del código igual...
    const params = new URLSearchParams({
        fechaInicio: filtros.fechaInicio,
        fechaFin: filtros.fechaFin,
        accion: filtros.accion,
        usuario_id: filtros.usuario,
        cliente_id: filtros.cliente,
        orden: filtros.orden,
        limite: 1000
    });
    
    const url = `${API_BASE_URL}/api/auditoria/clientes?${params}`;
    
    try {
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.status === 403) {
            throw new Error('No tienes permisos para acceder a la auditoría');
        }
        
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.message || 'Error en la respuesta del servidor');
        }
        
        return data.data || [];
        
    } catch (error) {
        console.error('💥 Error en obtenerDatosAuditoria:', error);
        mostrarMensaje(`Error al obtener auditoría: ${error.message}`, 'error');
        throw error;
    }
}
// Generar vista previa de auditoría
async function generarVistaPreviaAuditoria() {
    const vistaPrevia = document.getElementById('vista-previa-auditoria');
    const estadisticas = document.getElementById('estadisticas-auditoria');
    
    if (!vistaPrevia) return;
    
    vistaPrevia.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-indigo-600 text-xl mb-2"></i><p class="text-gray-600">Cargando auditoría...</p></div>';
    
    try {
        const filtros = obtenerFiltrosAuditoria();
        const datosAuditoria = await obtenerDatosAuditoria(filtros);
        
        mostrarVistaPreviaAuditoria(datosAuditoria, filtros);
        mostrarEstadisticasAuditoria(datosAuditoria);
        
    } catch (error) {
        console.error('❌ Error generando vista previa de auditoría:', error);
        vistaPrevia.innerHTML = `
            <div class="text-center py-4 text-red-600">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Error al cargar auditoría: ${error.message}
            </div>
        `;
    }
}

// Mostrar vista previa de auditoría
function mostrarVistaPreviaAuditoria(datos, filtros) {
    const vistaPrevia = document.getElementById('vista-previa-auditoria');
    if (!vistaPrevia) return;
    
    if (!datos || datos.length === 0) {
        vistaPrevia.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i>
                <p class="text-gray-500">No hay registros de auditoría para el período seleccionado</p>
                <p class="text-gray-400 text-sm mt-2">Período: ${filtros.fechaInicio} al ${filtros.fechaFin}</p>
            </div>
        `;
        return;
    }
    
    const iconosAccion = {
        'crear': 'plus-circle',
        'actualizar': 'edit',
        'eliminar': 'trash'
    };
    
    const coloresAccion = {
        'crear': 'bg-green-100 text-green-800',
        'actualizar': 'bg-blue-100 text-blue-800',
        'eliminar': 'bg-red-100 text-red-800'
    };
    
    let html = `
        <div class="overflow-x-auto border rounded-lg">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 border text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th>
                        <th class="px-4 py-3 border text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                        <th class="px-4 py-3 border text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th>
                        <th class="px-4 py-3 border text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                        <th class="px-4 py-3 border text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cambios</th>
                        <th class="px-4 py-3 border text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
    `;
    
    datos.forEach(item => {
        const fecha = new Date(item.fecha);
        const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        let cambiosHTML = 'Sin cambios específicos';
        if (item.campos_cambiados) {
            const cambios = typeof item.campos_cambiados === 'string' ? 
                JSON.parse(item.campos_cambiados) : item.campos_cambiados;
            
            cambiosHTML = Object.keys(cambios).slice(0, 2).map(campo => {
                const nombreCampo = {
                    'nombre': 'Nombre',
                    'empresa': 'Empresa',
                    'telefono': 'Teléfono',
                    'celular': 'Celular',
                    'correo': 'Correo',
                    'asesor_id': 'Asesor',
                    'status': 'Estado',
                    'razon_social': 'Razón Social'
                }[campo] || campo;
                
                return `<div class="text-xs">
                    <span class="font-medium">${nombreCampo}</span> 
                    <span class="text-red-500">→</span> 
                    <span class="text-green-600">${cambios[campo].nuevo || 'vacío'}</span>
                </div>`;
            }).join('');
            
            if (Object.keys(cambios).length > 2) {
                cambiosHTML += `<div class="text-xs text-gray-500">+${Object.keys(cambios).length - 2} más</div>`;
            }
        }
        
        html += `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3 border text-sm text-gray-600 whitespace-nowrap">
                    ${fechaFormateada}
                </td>
                <td class="px-4 py-3 border text-sm font-medium text-gray-900">
                    ${item.usuario_nombre || 'Sistema'}
                </td>
                <td class="px-4 py-3 border text-sm">
                    <span class="px-2 py-1 text-xs rounded-full font-medium ${coloresAccion[item.accion]} capitalize">
                        <i class="fas fa-${iconosAccion[item.accion]} mr-1"></i>
                        ${item.accion}
                    </span>
                </td>
                <td class="px-4 py-3 border text-sm">
                    <div class="font-medium">${item.cliente_nombre || 'Cliente #' + item.cliente_id}</div>
                    <div class="text-xs text-gray-500">${item.cliente_empresa || 'Sin empresa'}</div>
                </td>
                <td class="px-4 py-3 border text-sm">
                    ${cambiosHTML}
                </td>
                <td class="px-4 py-3 border text-sm text-gray-500 text-xs">
                    ${item.ip_address || 'N/A'}
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-600"><strong>Período:</strong> ${filtros.fechaInicio} al ${filtros.fechaFin}</p>
            <p class="text-sm text-gray-600"><strong>Total de registros:</strong> ${datos.length}</p>
            <p class="text-xs text-gray-500 mt-1">Vista previa generada el ${new Date().toLocaleString()}</p>
        </div>
    `;
    
    vistaPrevia.innerHTML = html;
}

// Mostrar estadísticas de auditoría
function mostrarEstadisticasAuditoria(datos) {
    const estadisticas = document.getElementById('estadisticas-auditoria');
    if (!estadisticas) return;
    
    const total = datos.length;
    const creaciones = datos.filter(d => d.accion === 'crear').length;
    const actualizaciones = datos.filter(d => d.accion === 'actualizar').length;
    const eliminaciones = datos.filter(d => d.accion === 'eliminar').length;
    
    document.getElementById('total-cambios').textContent = total;
    document.getElementById('total-creaciones').textContent = creaciones;
    document.getElementById('total-actualizaciones').textContent = actualizaciones;
    document.getElementById('total-eliminaciones').textContent = eliminaciones;
    
    estadisticas.classList.remove('hidden');
}

// Generar PDF de auditoría - VERSIÓN CORREGIDA
async function generarPDFAuditoria() {
    try {
        console.log('🔄 Generando PDF de auditoría...');
        
        if (typeof window.jspdf === 'undefined') {
            throw new Error('La librería jsPDF no está cargada');
        }
        
        mostrarMensaje('Generando PDF de auditoría...', 'info');
        
        const filtros = obtenerFiltrosAuditoria();
        const datosAuditoria = await obtenerDatosAuditoria(filtros);
        
        if (!datosAuditoria || datosAuditoria.length === 0) {
            mostrarMensaje('No hay datos de auditoría para generar el PDF', 'warning');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 14;

        // Logo y encabezado
        const LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAABkCAYAAADTf2piAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAgSURBVHgB7cEBDQAAAMIg+6d+FLjAAAAAAAAAAAAAAAAAAAAA4A8zOAAF3gAAAABJRU5ErkJggg==';
        
        try {
            doc.addImage(LOGO_BASE64, 'PNG', margin, 10, 40, 15);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('SOLAREVER', margin + 45, 18);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('Quality is our life', margin + 45, 23);
        } catch (error) {
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('SOLAREVER', margin, 15);
            doc.setFontSize(10);
            doc.text('Quality is our life', margin, 22);
        }

        // Título
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.text('AUDITORÍA DE CAMBIOS', pageWidth / 2, 40, { align: 'center' });
        
        // Información del reporte
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Período: ${formatearFecha(filtros.fechaInicio)} - ${formatearFecha(filtros.fechaFin)}`, margin, 55);
        doc.text(`Generado: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margin, 62);
        doc.text(`Total de registros: ${datosAuditoria.length}`, margin, 69);
        
        // Estadísticas
        const creaciones = datosAuditoria.filter(d => d.accion === 'crear').length;
        const actualizaciones = datosAuditoria.filter(d => d.accion === 'actualizar').length;
        const eliminaciones = datosAuditoria.filter(d => d.accion === 'eliminar').length;
        
        doc.text(`Creaciones: ${creaciones}`, pageWidth - margin, 55, { align: 'right' });
        doc.text(`Actualizaciones: ${actualizaciones}`, pageWidth - margin, 62, { align: 'right' });
        doc.text(`Eliminaciones: ${eliminaciones}`, pageWidth - margin, 69, { align: 'right' });

        // Preparar datos para la tabla
        const tableData = datosAuditoria.map(item => {
            const fecha = new Date(item.fecha);
            const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let cambiosTexto = 'Sin cambios';
            if (item.campos_cambiados) {
                const cambios = typeof item.campos_cambiados === 'string' ? 
                    JSON.parse(item.campos_cambiados) : item.campos_cambiados;
                
                cambiosTexto = Object.keys(cambios).slice(0, 3).map(campo => {
                    const nombreCampo = {
                        'nombre': 'Nom', 'empresa': 'Emp', 'telefono': 'Tel',
                        'celular': 'Cel', 'correo': 'Cor', 'status': 'Est',
                        'razon_social': 'RazSoc'
                    }[campo] || campo.substring(0, 5);
                    
                    return `${nombreCampo}:${cambios[campo].nuevo || '-'}`;
                }).join(', ');
                
                if (Object.keys(cambios).length > 3) {
                    cambiosTexto += `... (+${Object.keys(cambios).length - 3})`;
                }
            }
            
            // MOSTRAR IP CORRECTAMENTE - SI ES NULL MOSTRAR "N/A"
            const ipMostrar = item.ip_address && item.ip_address !== 'null' ? item.ip_address : 'N/A';
            
            return [
                fechaFormateada,
                item.usuario_nombre || 'Sistema',
                item.accion.toUpperCase(),
                (item.cliente_nombre || 'Cliente').substring(0, 20),
                cambiosTexto.substring(0, 40),
                ipMostrar // 👈 IP corregida
            ];
        });
        
        // Crear tabla
        doc.autoTable({
            startY: 80,
            head: [
                ['Fecha/Hora', 'Usuario', 'Acción', 'Cliente', 'Cambios', 'IP']
            ],
            body: tableData,
            theme: 'grid',
            headStyles: {
                fillColor: [79, 70, 229],
                textColor: 255,
                fontStyle: 'bold',
                fontSize: 8
            },
            styles: {
                fontSize: 7,
                cellPadding: 2
            },
            columnStyles: {
                0: { cellWidth: 25 },
                1: { cellWidth: 20 },
                2: { cellWidth: 15 },
                3: { cellWidth: 25 },
                4: { cellWidth: 45 },
                5: { cellWidth: 25 } // 👈 Más espacio para IP
            }
        });
        
        // Pie de página
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(128);
            doc.text(
                `Página ${i} de ${pageCount} - SOLAREVER Auditoría - ${new Date().toLocaleDateString()}`,
                pageWidth / 2,
                doc.internal.pageSize.getHeight() - 10,
                { align: 'center' }
            );
        }
        
        // Descargar
        const nombreArchivo = `Auditoria_SOLAREVER_${filtros.fechaInicio}_a_${filtros.fechaFin}.pdf`;
        doc.save(nombreArchivo);
        
        console.log('✅ PDF de auditoría generado exitosamente');
        mostrarMensaje('PDF de auditoría generado exitosamente', 'success');
        
    } catch (error) {
        console.error('❌ Error generando PDF de auditoría:', error);
        mostrarMensaje('Error al generar PDF: ' + error.message, 'error');
    }
}
// Cargar usuarios en el filtro - CON MANEJO DE PERMISOS
async function cargarOpcionesUsuariosAuditoria() {
    const select = document.getElementById('filtro-usuario');
    if (!select) return;
    
    select.innerHTML = '<option value="todos">Todos los usuarios</option>';
    
    try {
        const response = await fetchWithAuth(`${API_BASE_URL}/api/usuarios`);
        if (response) {
            if (response.status === 403) {
                console.warn('Usuario no tiene permisos para ver la lista de usuarios');
                return;
            }
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.data) {
                    data.data.forEach(usuario => {
                        const option = document.createElement('option');
                        option.value = usuario.id;
                        option.textContent = usuario.username;
                        select.appendChild(option);
                    });
                }
            }
        }
    } catch (error) {
        console.error('Error al cargar usuarios para auditoría:', error);
    }
}
// Función para probar la auditoría
async function probarAuditoria() {
    try {
        const response = await fetchWithAuth(`${API_BASE_URL}/api/auditoria/clientes?limite=10`);
        if (response && response.ok) {
            const data = await response.json();
            console.log('🔍 Registros de auditoría:', data.data);
            return data.data;
        }
    } catch (error) {
        console.error('Error al obtener auditoría:', error);
    }
}

// Ejecutar depuración
setTimeout(() => {
    console.log('=== DEPURACIÓN AUDITORÍA ===');
    probarAuditoria();
}, 3000);
// Función de diagnóstico para auditoría
async function diagnosticarAuditoria() {
    try {
        console.log('=== DIAGNÓSTICO AUDITORÍA ===');
        
        // Probar endpoint básico
        const testResponse = await fetch(`${API_BASE_URL}/api/auditoria/clientes?limite=2`, {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('crm_token'),
                'Content-Type': 'application/json'
            }
        });
        
        console.log('Status del test:', testResponse.status);
        console.log('OK:', testResponse.ok);
        
        if (!testResponse.ok) {
            const errorText = await testResponse.text();
            console.error('Error del servidor:', errorText);
            return;
        }
        
        const testData = await testResponse.json();
        console.log('Datos de prueba:', testData);
        
    } catch (error) {
        console.error('Error en diagnóstico:', error);
    }
}

// Ejecutar diagnóstico
setTimeout(diagnosticarAuditoria, 1000);
// test-ip-avanzado.js
///const axios = require('axios');

///const baseURL = 'http://localhost:3000';

///async function pruebaCompletaIP() {
///  console.log('🧪 INICIANDO PRUEBA COMPLETA DE IP...\n');
  
///  try {
    // Prueba 1: Request normal
///    console.log('1. 📞 Request normal...');
///    const response1 = await axios.get(`${baseURL}/api/debug/ip-completo`);
///    console.log('✅ Response:', JSON.stringify(response1.data.data.ip_determinada, null, 2));
    
    // Prueba 2: Con headers personalizados (simulando proxy)
///    console.log('\n2. 🔄 Request con headers de proxy...');
///    const response2 = await axios.get(`${baseURL}/api/debug/ip-completo`, {
///      headers: {
///        'X-Forwarded-For': '201.168.45.123, 10.0.0.1, 192.168.1.1',
///        'X-Real-IP': '201.168.45.123',
///        'CF-Connecting-IP': '201.168.45.123'
///      }
///    });
///    console.log('✅ Response:', JSON.stringify(response2.data.data.ip_determinada, null, 2));
    
    // Prueba 3: Otra IP simulada
 ///   console.log('\n3. 🌍 Request con otra IP...');
///    const response3 = await axios.get(`${baseURL}/api/debug/ip-completo`, {
///      headers: {
///        'X-Forwarded-For': '187.190.45.67, 10.0.0.2, 192.168.1.2'
///      }
///    });
///    console.log('✅ Response:', JSON.stringify(response3.data.data.ip_determinada, null, 2));
    
///    console.log('\n🎉 PRUEBA COMPLETADA - Revisa los logs del servidor para más detalles');
    
///  } catch (error) {
///    console.error('❌ Error en la prueba:', error.message);
///  }
///}

///pruebaCompletaIP();
// =====================
// CONTROL DE INACTIVIDAD
// =====================
let inactividadTimer;
const tiempoMaximo = 5 * 60 * 1000; // 5 minutos

function reiniciarTemporizador() {
  clearTimeout(inactividadTimer);
  inactividadTimer = setTimeout(() => {
    alert("Sesión expirada por inactividad.");
    localStorage.removeItem('token');
    localStorage.removeItem('role');
    window.location.href = "login.html";
  }, tiempoMaximo);
}

// Detectar eventos de actividad
['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt =>
  document.addEventListener(evt, reiniciarTemporizador)
);

// Iniciar contador al cargar la página
reiniciarTemporizador();

</script>
<script>
// ========================================
// POLLING SEGURO PARA RFID - SOLO SI HAY USUARIO
// ========================================
let rfidPollingInterval = null;
let pollingActivo = false;

function iniciarPollingRFID() {
    if (pollingActivo) return;
    
    const usuario = JSON.parse(localStorage.getItem('usuario_logeado'));
    
    // Solo iniciar polling si hay un usuario logueado
    if (!usuario || !usuario.token) {
        console.log('⚠️ No hay usuario logueado, no se inicia polling RFID');
        return;
    }
    
    console.log('🔄 Iniciando polling RFID seguro...');
    pollingActivo = true;
    
    rfidPollingInterval = setInterval(async () => {
        try {
            const response = await fetch('http://localhost:3000/api/rfid/ultimo');
            const data = await response.json();
            
            if (data.success && data.token && data.user) {
                console.log('🎫 Nuevo RFID detectado, actualizando sesión...');
                
                // Actualizar localStorage
                localStorage.setItem('usuario_logeado', JSON.stringify({
                    username: data.user.username,
                    role: data.user.role,
                    token: data.token
                }));
                localStorage.setItem('crm_token', data.token);
                
                // Limpiar el acceso RFID
                await fetch('http://localhost:3000/api/rfid/reset', { 
                    method: 'POST' 
                });
                
                // Recargar para aplicar cambios (nuevos permisos, etc.)
                console.log('🔄 Recargando página con nuevo usuario...');
                window.location.reload();
            }
        } catch (error) {
            console.log('❌ Error en polling RFID:', error);
        }
    }, 3000); // Verificar cada 3 segundos
}

function detenerPollingRFID() {
    if (rfidPollingInterval) {
        clearInterval(rfidPollingInterval);
        rfidPollingInterval = null;
    }
    pollingActivo = false;
    console.log('🧹 Polling RFID detenido');
}

// Iniciar polling solo si estamos en la página principal y hay un usuario logueado
document.addEventListener('DOMContentLoaded', function() {
    const usuario = JSON.parse(localStorage.getItem('usuario_logeado'));
    
    if (usuario && usuario.token) {
        console.log('👤 Usuario logueado, iniciando polling...');
        iniciarPollingRFID();
    } else {
        console.log('⚠️ No hay usuario logueado, redirigiendo a login...');
        // Redirigir a login después de un breve tiempo
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 1000);
    }
});
// Agrega esto en setupMenu() o setupForms():
document.getElementById('btn-cerrar-sesion').addEventListener('click', cerrarSesion);
</script>
<script>
// Función de diagnóstico para reportes PDF
async function diagnosticarReportesPDF() {
    try {
        console.log('=== DIAGNÓSTICO REPORTES PDF ===');
        
        // Probar endpoint básico
        const testResponse = await fetch(`${API_BASE_URL}/api/reportes/clientes?fechaInicio=2024-01-01&fechaFin=2024-12-31`, {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('crm_token'),
                'Content-Type': 'application/json'
            }
        });
        
        console.log('Status del test:', testResponse.status);
        console.log('OK:', testResponse.ok);
        
        if (!testResponse.ok) {
            const errorText = await testResponse.text();
            console.error('Error del servidor:', errorText);
        } else {
            const testData = await testResponse.json();
            console.log('Datos de prueba:', testData);
        }
        
    } catch (error) {
        console.error('Error en diagnóstico:', error);
    }
}

// Ejecutar diagnóstico después de cargar
setTimeout(diagnosticarReportesPDF, 2000);
</script>
<script>
// DIAGNÓSTICO DE AUDITORÍA
function diagnosticarAuditoriaCompleto() {
    console.log('=== DIAGNÓSTICO COMPLETO AUDITORÍA ===');
    
    // Verificar elementos del DOM
    const navAuditoria = document.getElementById('nav-auditoria');
    const auditoriaSection = document.getElementById('auditoria-section');
    
    console.log('🔍 Elemento nav-auditoria:', navAuditoria);
    console.log('🔍 Elemento auditoria-section:', auditoriaSection);
    
    // Verificar event listeners
    if (navAuditoria) {
        console.log('✅ Elemento nav-auditoria encontrado');
        
        // Re-asignar event listener
        navAuditoria.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('🎯 Click en Auditoría detectado');
            
            const { usuario, token } = obtenerUsuarioLogueado();
            console.log('👤 Usuario actual:', usuario);
            
            if (!usuario) {
                mostrarMensaje('No hay usuario logueado', 'error');
                return;
            }
            
            // Mostrar sección de auditoría
            mostrarSeccion('auditoria-section');
            document.getElementById('page-title').textContent = 'Auditoría de Cambios';
            
            // Inicializar auditoría
            if (typeof inicializarAuditoria === 'function') {
                inicializarAuditoria();
            } else {
                console.error('❌ función inicializarAuditoria no existe');
                cargarDatosAuditoria(); // Intentar cargar directamente
            }
        });
    } else {
        console.error('❌ Elemento nav-auditoria NO encontrado');
    }
}

// Función para cargar datos de auditoría
function cargarDatosAuditoria() {
    console.log('📊 Cargando datos de auditoría...');
    
    const { token } = obtenerUsuarioLogueado();
    
    // Parámetros básicos
    const fechaFin = new Date().toISOString().split('T')[0];
    const fechaInicio = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    
    fetch(`/api/auditoria/clientes?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}&limite=50&pagina=1`, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('📡 Respuesta auditoría - Status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('📊 Datos auditoría recibidos:', data);
        
        if (data.success) {
            // Aquí procesar los datos de auditoría
            console.log(`✅ ${data.data.length} registros de auditoría cargados`);
            mostrarMensaje('Auditoría cargada exitosamente', 'success');
        } else {
            console.error('❌ Error en auditoría:', data.message);
            mostrarMensaje('Error al cargar auditoría: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('❌ Error fetching auditoría:', error);
        mostrarMensaje('Error de conexión al cargar auditoría', 'error');
    });
}

// Ejecutar diagnóstico después de cargar la página
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        diagnosticarAuditoriaCompleto();
    }, 1000);
});
</script>
<script>
// ========================================
// CONFIGURACIÓN IMGBB
// ========================================

// 🔑 REEMPLAZA ESTO CON TU API KEY REAL DE IMGBB
const IMGBB_API_KEY = '80b3766801fc99e37fd2578ca9c131d0';

// ========================================
// FUNCIONES DE SUBIDA
// ========================================

// Subir archivo a ImgBB
async function uploadToImgBB(file) {
    const formData = new FormData();
    formData.append('image', file);
    
    // Mostrar progreso
    showUploadProgress();
    
    try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            return {
                success: true,
                url: data.data.url,
                thumb: data.data.thumb?.url || data.data.url,
                name: data.data.image.filename || file.name,
                size: data.data.size
            };
        } else {
            throw new Error(data.error?.message || 'Error desconocido de ImgBB');
        }
        
    } catch (error) {
        console.error('Error subiendo a ImgBB:', error);
        return {
            success: false,
            error: error.message
        };
    } finally {
        hideUploadProgress();
    }
}

// Mostrar vista previa del documento
function showDocumentPreview(fileInfo) {
    const previewContent = document.getElementById('preview-content');
    const isPDF = fileInfo.name.toLowerCase().endsWith('.pdf');
    
    if (isPDF) {
        previewContent.innerHTML = `
            <div class="flex items-center space-x-3">
                <i class="fas fa-file-pdf text-4xl text-red-500"></i>
                <div>
                    <p class="text-sm font-medium text-gray-900">${fileInfo.name}</p>
                    <p class="text-xs text-gray-500">PDF Document</p>
                </div>
            </div>
        `;
    } else {
        previewContent.innerHTML = `
            <div class="flex items-center space-x-3">
                <img src="${fileInfo.thumb}" alt="Vista previa" class="w-16 h-16 object-cover rounded border">
                <div>
                    <p class="text-sm font-medium text-gray-900">${fileInfo.name}</p>
                    <p class="text-xs text-gray-500">Imagen</p>
                </div>
            </div>
        `;
    }
    
    // Actualizar enlaces y campos ocultos
    document.getElementById('imgbb-url').value = fileInfo.url;
    document.getElementById('view-document-link').href = fileInfo.url;
    document.getElementById('document-preview').classList.remove('hidden');
    
    mostrarMensaje('✅ Documento subido correctamente', 'success');
}

// Manejar la subida de archivos
async function handleFileUpload(file) {
    // Validaciones
    if (!file) return;
    
    const maxSize = 32 * 1024 * 1024; // 32MB
    if (file.size > maxSize) {
        mostrarMensaje('❌ El archivo es muy grande (máximo 32MB)', 'error');
        return;
    }
    
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'application/pdf'];
    if (!allowedTypes.includes(file.type)) {
        mostrarMensaje('❌ Formato no permitido. Usa PDF, JPG o PNG', 'error');
        return;
    }
    
    // Subir a ImgBB
    const result = await uploadToImgBB(file);
    
    if (result.success) {
        showDocumentPreview(result);
    } else {
        mostrarMensaje('❌ Error subiendo documento: ' + result.error, 'error');
    }
}

// Mostrar/ocultar progreso de subida
function showUploadProgress() {
    document.getElementById('upload-area').classList.add('hidden');
    document.getElementById('upload-progress').classList.remove('hidden');
    
    // Animación de progreso (simulada)
    let progress = 0;
    const progressBar = document.getElementById('progress-bar');
    const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 90) {
            clearInterval(interval);
            progressBar.style.width = '90%';
        } else {
            progressBar.style.width = progress + '%';
        }
    }, 200);
}

function hideUploadProgress() {
    document.getElementById('upload-area').classList.remove('hidden');
    document.getElementById('upload-progress').classList.add('hidden');
    document.getElementById('progress-bar').style.width = '0%';
}

// ========================================
// EVENT LISTENERS
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('document-upload');
    const uploadArea = document.getElementById('upload-area');
    const removeBtn = document.getElementById('remove-document-btn');
    
    // Click en área de subida
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });
    
    // Cambio en input de archivo
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleFileUpload(file);
        }
    });
    
    // Drag & drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('border-indigo-500', 'bg-indigo-50');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('border-indigo-500', 'bg-indigo-50');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('border-indigo-500', 'bg-indigo-50');
        
        const file = e.dataTransfer.files[0];
        if (file) {
            handleFileUpload(file);
        }
    });
    
    // Eliminar documento
    removeBtn.addEventListener('click', () => {
        document.getElementById('document-preview').classList.add('hidden');
        document.getElementById('imgbb-url').value = '';
        fileInput.value = '';
        mostrarMensaje('Documento eliminado', 'success');
    });
});

// ========================================
// ACTUALIZAR EL OBJETO clienteData
// ========================================

// En la función de envío del formulario, modifica el objeto clienteData:
const clienteData = {
    // ... tus otros campos existentes ...
    
    // ✅ AGREGAR ESTOS CAMPOS DE IMGBB:
    imgbb_url: document.getElementById('imgbb-url').value,
    documento_subido: document.getElementById('imgbb-url').value ? 'si' : 'no',
    
    // ... resto de campos ...
};

// ========================================
// VALIDACIÓN DEL FORMULARIO
// ========================================

// Agrega esta validación en tu función validarFormularioCliente:
function validarFormularioCliente(form) {
    // ... tus validaciones existentes ...
    
    // ✅ Validar que se haya subido un documento
    const documentoSubido = document.getElementById('imgbb-url').value;
    if (!documentoSubido) {
        mostrarMensaje('❌ Debes subir el documento de CFE', 'error');
        return false;
    }
    
    return true;
}
</script>
<script>
// ========================================
// FUNCIONALIDAD DE SUBIDA PARA FORMULARIO DE EDICIÓN
// ========================================

// Inicializar funcionalidad de subida para edición
function inicializarSubidaEdicion() {
    const editDocumentUpload = document.getElementById('edit-document-upload');
    const editImgbbUrl = document.getElementById('edit-imgbb-url');
    const editDocumentPreview = document.getElementById('edit-document-preview');
    const editViewDocumentLink = document.getElementById('edit-view-document-link');
    const editRemoveDocumentBtn = document.getElementById('edit-remove-document-btn');

    if (!editDocumentUpload) {
        console.warn('Elemento edit-document-upload no encontrado');
        return;
    }

    // Event listener para subida de archivos
    editDocumentUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            subirDocumentoImgBB(file, 'edit');
        }
    });

    // Event listener para eliminar documento
    if (editRemoveDocumentBtn) {
        editRemoveDocumentBtn.addEventListener('click', function() {
            eliminarDocumentoEdicion();
        });
    }

    console.log('✅ Funcionalidad de subida para edición inicializada');
}

// Función para subir documento a ImgBB (versión para edición)
function subirDocumentoImgBB(file, tipo = 'edit') {
    const apiKey = '80b3766801fc99e37fd2578ca9c131d0'; // Reemplaza con tu API key
    
    const formData = new FormData();
    formData.append('image', file);
    formData.append('key', apiKey);

    // Mostrar indicador de carga
    mostrarCargaDocumento(tipo);

    fetch('https://api.imgbb.com/1/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const imageUrl = data.data.url;
            actualizarInterfazDocumento(imageUrl, tipo);
            console.log(`✅ Documento subido exitosamente (${tipo}):`, imageUrl);
        } else {
            throw new Error(data.error?.message || 'Error al subir documento');
        }
    })
    .catch(error => {
        console.error(`❌ Error subiendo documento (${tipo}):`, error);
        alert('Error al subir documento: ' + error.message);
        ocultarCargaDocumento(tipo);
    });
}

// Función para actualizar la interfaz cuando se carga un documento
function actualizarInterfazDocumento(url, tipo = 'edit') {
    const prefix = tipo === 'edit' ? 'edit-' : '';
    
    const imgbbUrl = document.getElementById(`${prefix}imgbb-url`);
    const documentPreview = document.getElementById(`${prefix}document-preview`);
    const viewDocumentLink = document.getElementById(`${prefix}view-document-link`);
    const documentUpload = document.getElementById(`${prefix}document-upload`);

    // Actualizar campo oculto
    if (imgbbUrl) {
        imgbbUrl.value = url;
    }

    // Actualizar enlace de vista
    if (viewDocumentLink) {
        viewDocumentLink.href = url;
    }

    // Mostrar vista previa
    if (documentPreview) {
        documentPreview.style.display = 'block';
    }

    // Limpiar input file
    if (documentUpload) {
        documentUpload.value = '';
    }

    ocultarCargaDocumento(tipo);
}

// Función para eliminar documento en edición
function eliminarDocumentoEdicion() {
    const editImgbbUrl = document.getElementById('edit-imgbb-url');
    const editDocumentPreview = document.getElementById('edit-document-preview');
    const editViewDocumentLink = document.getElementById('edit-view-document-link');
    const editDocumentUpload = document.getElementById('edit-document-upload');

    // Limpiar campo oculto
    if (editImgbbUrl) {
        editImgbbUrl.value = '';
    }

    // Ocultar vista previa
    if (editDocumentPreview) {
        editDocumentPreview.style.display = 'none';
    }

    // Limpiar enlace
    if (editViewDocumentLink) {
        editViewDocumentLink.href = '#';
    }

    // Limpiar input file
    if (editDocumentUpload) {
        editDocumentUpload.value = '';
    }

    console.log('🗑️ Documento eliminado en formulario de edición');
}

// Funciones auxiliares para mostrar/ocultar carga
function mostrarCargaDocumento(tipo = 'edit') {
    const prefix = tipo === 'edit' ? 'edit-' : '';
    const documentPreview = document.getElementById(`${prefix}document-preview`);
    
    if (documentPreview) {
        documentPreview.innerHTML = '<span>⏳ Subiendo documento...</span>';
        documentPreview.style.display = 'block';
    }
}

function ocultarCargaDocumento(tipo = 'edit') {
    // Esta función se llama después de actualizar la interfaz
    // La interfaz ya debería estar actualizada en este punto
}

// ========================================
// FUNCIÓN PARA CARGAR DATOS EN FORMULARIO DE EDICIÓN
// ========================================

// Función mejorada para cargar datos en el formulario de edición
function cargarDatosEdicion(cliente) {
    console.log('📥 Cargando datos para edición:', cliente);
    
    // Cargar datos básicos
    document.getElementById('edit-client-id').value = cliente.id;
    document.getElementById('edit-nombre').value = cliente.nombre || '';
    document.getElementById('edit-empresa').value = cliente.empresa || '';
    document.getElementById('edit-correo').value = cliente.correo || '';
    // ... otros campos ...

    // CARGAR DATOS DEL DOCUMENTO (PARTE CRÍTICA)
    cargarDocumentoExistente(cliente);
}

// Función específica para manejar el documento existente
function cargarDocumentoExistente(cliente) {
    const editImgbbUrl = document.getElementById('edit-imgbb-url');
    const editDocumentPreview = document.getElementById('edit-document-preview');
    const editViewDocumentLink = document.getElementById('edit-view-document-link');
    const editDocumentUpload = document.getElementById('edit-document-upload');

    // Verificar si hay documento existente
    const tieneDocumento = cliente.imgbb_url || cliente.documento_subido;
    const urlDocumento = cliente.imgbb_url || cliente.documento_subido;

    if (tieneDocumento && urlDocumento) {
        // Actualizar campo oculto
        if (editImgbbUrl) {
            editImgbbUrl.value = urlDocumento;
        }

        // Actualizar enlace de vista
        if (editViewDocumentLink) {
            editViewDocumentLink.href = urlDocumento;
            editViewDocumentLink.textContent = 'Ver documento actual';
        }

        // Mostrar vista previa
        if (editDocumentPreview) {
            editDocumentPreview.style.display = 'block';
        }

        console.log('📄 Documento existente cargado:', urlDocumento);
    } else {
        // No hay documento, limpiar interfaz
        if (editImgbbUrl) editImgbbUrl.value = '';
        if (editDocumentPreview) editDocumentPreview.style.display = 'none';
        if (editViewDocumentLink) {
            editViewDocumentLink.href = '#';
            editViewDocumentLink.textContent = 'Ver documento';
        }
        if (editDocumentUpload) editDocumentUpload.value = '';

        console.log('📭 No hay documento existente para este cliente');
    }
}

// ========================================
// INICIALIZACIÓN AL CARGAR LA PÁGINA
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Inicializando funcionalidades de documento...');
    
    // Inicializar funcionalidad para formulario de edición
    inicializarSubidaEdicion();
    
    // Si usas un modal para edición, inicializar cuando se abra
    const editModal = document.getElementById('edit-client-modal');
    if (editModal) {
        editModal.addEventListener('shown.bs.modal', function() {
            console.log('📋 Modal de edición abierto - reinicializando subida');
            inicializarSubidaEdicion();
        });
    }

    console.log('✅ Todas las funcionalidades de documento inicializadas');
});

// ========================================
// FUNCIÓN PARA ENVIAR FORMULARIO DE EDICIÓN
// ========================================

// Función mejorada para enviar el formulario de edición
function enviarFormularioEdicion(event) {
    event.preventDefault();
    
    const formData = new FormData(document.getElementById('edit-client-form'));
    const clienteId = document.getElementById('edit-client-id').value;
    
    // Asegurarse de que la URL de ImgBB se incluya
    const imgbbUrl = document.getElementById('edit-imgbb-url').value;
    if (imgbbUrl) {
        formData.append('imgbb_url', imgbbUrl);
    }

    console.log('📤 Enviando datos de edición:', {
        clienteId: clienteId,
        imgbbUrl: imgbbUrl
    });

    // Aquí tu lógica existente para enviar a /api/clientes/:id
    fetch(`/api/clientes/${clienteId}`, {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(Object.fromEntries(formData))
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Cliente actualizado exitosamente');
            // Cerrar modal, recargar datos, etc.
        } else {
            throw new Error(data.message);
        }
    })
    .catch(error => {
        console.error('❌ Error actualizando cliente:', error);
        alert('Error al actualizar cliente: ' + error.message);
    });
}
</script>
</body>
</html>