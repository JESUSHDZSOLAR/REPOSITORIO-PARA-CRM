<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval';
    style-src 'self' https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline';
    font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com;
    connect-src 'self' http://localhost:3000;
    img-src 'self' data: https:;
">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso - MI SOLAREVER</title>
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #10b981;
        }
        .rfid-notification {
    border-left: 4px solid #4f46e5;
    min-width: 300px;
}

.swal2-popup.swal2-toast .swal2-title {
    font-size: 16px;
    margin-bottom: 8px;
}

.swal2-popup.swal2-toast .swal2-html-container {
    font-size: 14px;
    line-height: 1.4;
}
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-lg shadow-lg p-8">
            <div class="flex flex-col items-center mb-6">
                <img src="/img/Logo.png" alt="Logo Solarever" class="h-16 mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Acceso</h1>
                <p class="text-gray-500 mt-1 text-center">Inicia sesi√≥n para acceder a tu panel de CRM.</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Nombre de Usuario</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-user text-gray-400"></i>
                        </div>
                        <input type="text" id="username" name="username" required
                            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md 
                                   focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            placeholder="Tu nombre de usuario">
                    </div>
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-lock text-gray-400"></i>
                        </div>
                        <input type="password" id="password" name="password" required
                            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md 
                                   focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            placeholder="Tu contrase√±a">
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox"
                            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900">
                            Recordarme
                        </label>
                    </div>
                </div>

                <div>
                    <button type="submit"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm 
                               text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 
                               focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-sign-in-alt mr-2"></i> Iniciar Sesi√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>
  
<script>
// Funci√≥n para mostrar alertas (fallback si SweetAlert2 no carga)
function mostrarAlerta(titulo, mensaje, tipo = 'info') {
    // Intentar usar SweetAlert2 si est√° disponible
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: titulo,
            text: mensaje,
            icon: tipo,
            confirmButtonText: 'OK'
        });
    } else {
        // Fallback a alertas nativas
        if (tipo === 'error') {
            alert(`‚ùå ${titulo}\n${mensaje}`);
        } else if (tipo === 'success') {
            alert(`‚úÖ ${titulo}\n${mensaje}`);
        } else {
            alert(`${titulo}\n${mensaje}`);
        }
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const loginForm = document.getElementById('login-form');

    // Si ya est√° logueado, redirigir autom√°ticamente
    const usuario = JSON.parse(localStorage.getItem('usuario_logeado'));
    if (usuario && usuario.token) {
        window.location.href = 'nuevo - copia.html';
        return;
    }

    loginForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        // Mostrar loading
        const submitBtn = loginForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Iniciando sesi√≥n...';
        submitBtn.disabled = true;

        try {
            const response = await fetch('http://localhost:3000/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const result = await response.json();

            if (result.success) {
                // Guardar usuario completo
                localStorage.setItem('usuario_logeado', JSON.stringify({
                    username: result.user.username,
                    role: result.user.role,
                    token: result.token
                }));

                // Guardar token por separado (lo usan FASE6 y nuevo - copia)
                localStorage.setItem('crm_token', result.token);

                mostrarAlerta('¬°√âxito!', result.message, 'success');
                
                setTimeout(() => {
                    window.location.href = 'nuevo - copia.html';
                }, 1000);
                
            } else {
                mostrarAlerta('Error', result.message, 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        } catch (error) {
            console.error('Error de conexi√≥n:', error);
            mostrarAlerta('Error de conexi√≥n', 'No se pudo conectar al servidor. Aseg√∫rate de que el servidor est√© en funcionamiento.', 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
});

</script>
<script>
// ========================================
// POLLING AUTOM√ÅTICO PARA RFID EN LOGIN 
// ========================================

let rfidPollingInterval = null;
let ultimoRFIDProcesado = null;
let ultimoEstadoRFID = null; // 'permitido', 'denegado', o null
let tiempoUltimoDenegado = 0;

function mostrarNotificacionRFID(titulo, mensaje, tipo = 'info') {
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: titulo,
            html: mensaje,
            icon: tipo,
            timer: tipo === 'error' ? 4000 : 3000,
            timerProgressBar: true,
            showConfirmButton: false,
            position: 'top-end',
            toast: true,
            background: tipo === 'error' ? '#fee' : '#f8f9fa',
            customClass: {
                popup: 'rfid-notification'
            }
        });
    } else {
        alert(`${titulo}\n${mensaje}`);
    }
}

function iniciarPollingRFIDLogin() {
    console.log('üîÑ Iniciando polling RFID desde login...');
    
    if (rfidPollingInterval) {
        clearInterval(rfidPollingInterval);
    }
    
    rfidPollingInterval = setInterval(async () => {
        try {
            const response = await fetch('http://localhost:3000/api/rfid/ultimo');
            
            if (!response.ok) {
                throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            const ahora = Date.now();
            
            // üî• EVITAR BUCLE: No procesar el mismo estado repetidamente
            const esMismoEstado = ultimoRFIDProcesado === data.rfidUID && ultimoEstadoRFID === (data.accessGranted ? 'permitido' : 'denegado');
            const denegadoReciente = (ahora - tiempoUltimoDenegado) < 5000; // 5 segundos de silencio despu√©s de denegado
            
            if (esMismoEstado || (ultimoEstadoRFID === 'denegado' && denegadoReciente)) {
                return; // Silenciosamente ignorar, no mostrar notificaci√≥n
            }
            
            // üî• CASO 1: ERROR DEL SERVIDOR
            if (data.success === false && data.accessGranted === undefined) {
                console.log('‚ùå ERROR DEL SERVIDOR detectado:', data);
                
                mostrarNotificacionRFID(
                    'üö´ ERROR DEL SISTEMA', 
                    `Problema t√©cnico: ${data.message || 'Error desconocido'}<br>Contacta al administrador`,
                    'error'
                );
                
                ultimoRFIDProcesado = data.rfidUID;
                ultimoEstadoRFID = 'error';
                return;
            }
            
            // üî• CASO 2: ACCESO DENEGADO (RFID incorrecto)
            if (data.success === false || data.accessGranted === false) {
                console.log('‚ùå RFID DENEGADO detectado en login:', data);
                
                // Solo mostrar si es un UID diferente o ha pasado suficiente tiempo
                if (!denegadoReciente || ultimoRFIDProcesado !== data.rfidUID) {
                    mostrarNotificacionRFID(
                        '‚ùå LLAVE INCORRECTA', 
                        'La tarjeta RFID no est√° autorizada<br>o no tiene permisos de acceso',
                        'error'
                    );
                }
                
                ultimoRFIDProcesado = data.rfidUID;
                ultimoEstadoRFID = 'denegado';
                tiempoUltimoDenegado = ahora;
                return;
            }
            
            // üî• CASO 3: ACCESO PERMITIDO
            if (data.success && data.accessGranted && data.token && data.user) {
                console.log('üé´ RFID AUTORIZADO detectado en login:', data);
                
                mostrarNotificacionRFID(
                    '‚úÖ ACCESO CORRECTO', 
                    `Bienvenido: <strong>${data.user.username}</strong><br>Rol: <strong>${data.user.role}</strong>`,
                    'success'
                );
                
                ultimoRFIDProcesado = data.rfidUID;
                ultimoEstadoRFID = 'permitido';
                
                // Guardar datos de usuario
                localStorage.setItem('usuario_logeado', JSON.stringify({
                    username: data.user.username,
                    role: data.user.role,
                    token: data.token
                }));
                localStorage.setItem('crm_token', data.token);
                
                // Esperar y redirigir
                setTimeout(async () => {
                    try {
                        await fetch('http://localhost:3000/api/rfid/reset', { 
                            method: 'POST' 
                        });
                    } catch (cleanupError) {
                        console.log('‚ö†Ô∏è Error limpiando RFID:', cleanupError);
                    }
                    
                    console.log('üîÑ Redirigiendo a p√°gina principal...');
                    window.location.href = 'nuevo - copia.html';
                }, 2000);
            }
            
        } catch (error) {
            console.log('‚ùå ERROR DE CONEXI√ìN en polling RFID:', error);
            
            // Solo mostrar error de conexi√≥n si no hemos mostrado uno recientemente
            const ahora = Date.now();
            if (ahora - tiempoUltimoDenegado > 10000) { // 10 segundos entre errores de conexi√≥n
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    mostrarNotificacionRFID(
                        'üåê ERROR DE CONEXI√ìN', 
                        'No se puede conectar al servidor<br>Verifica tu conexi√≥n de red',
                        'error'
                    );
                } else if (error.message.includes('Error del servidor')) {
                    mostrarNotificacionRFID(
                        'üö´ ERROR DEL SERVIDOR', 
                        `Problema en el servidor: ${error.message}<br>Intenta m√°s tarde`,
                        'error'
                    );
                }
                
                tiempoUltimoDenegado = ahora;
            }
        }
    }, 2000); // Verificar cada 2 segundos
}

// Funci√≥n para resetear el estado (√∫til cuando el usuario retira la tarjeta)
function resetearEstadoRFID() {
    ultimoRFIDProcesado = null;
    ultimoEstadoRFID = null;
    console.log('üîÑ Estado RFID reseteado - listo para nueva tarjeta');
}

// Iniciar polling autom√°ticamente al cargar la p√°gina de login
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîê P√°gina de login cargada, iniciando polling RFID...');
    iniciarPollingRFIDLogin();
    
    // Tambi√©n podr√≠as agregar un timer para resetear autom√°ticamente cada 30 segundos
    setInterval(resetearEstadoRFID, 30000);
    
    const usuario = JSON.parse(localStorage.getItem('usuario_logeado'));
    if (usuario && usuario.token) {
        console.log('üë§ Usuario ya logueado, redirigiendo...');
        window.location.href = 'nuevo - copia.html';
    }
});
</script>
<!-- Cargar SweetAlert2 al final para evitar bloqueos -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>

</html>
